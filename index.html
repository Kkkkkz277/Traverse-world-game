<!DOCTYPE html>
<!-- saved from url=(0052)https://mcp.edgeone.site/share/JH3SstQBZtdSf_3Lhpkcr -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¿«ç©¿æ¨¡æ‹Ÿå™¨</title>
    <style>
        /* --- å…¨å±€æ ·å¼ & å°‘å¥³å¿ƒå˜é‡ --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap');
        /* å¼•å…¥ Cropper.js æ ·å¼ */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css');

        :root {
            /* èƒŒæ™¯ä¸åŸºç¡€è‰² */
            --bg-gradient: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            
            /* å­—ä½“é¢œè‰² */
            --primary-text: #5D4037; 
            --secondary-text: #8D6E63;
            
            /* å¼ºè°ƒè‰² */
            --accent-color-1: #FF9EB5; /* æ¨±èŠ±ç²‰ */
            --accent-color-2: #FFD700; /* é‡‘è‰² */
            
            /* è®°å¿†é¢œè‰² */
            --memory-small: #77DD77;   /* é©¬å¡é¾™ç»¿ */
            --memory-big: #FF6961;     /* é©¬å¡é¾™çº¢ */
            
            /* é¢æ¿èƒŒæ™¯ - æ¯›ç»ç’ƒæ•ˆæœ */
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --topbar-color: rgba(255, 255, 255, 0.85);
            --topbar-img: none;
            --story-bg: rgba(255, 255, 255, 0.65);
            
            /* å¿ƒå£°é¢æ¿ */
            --thought-bg: rgba(230, 230, 250, 0.7);
            --thought-text: #6A5ACD;
            
            --panel-border: 1px solid rgba(255, 255, 255, 0.9);
            --panel-shadow: 0 8px 32px 0 rgba(255, 158, 181, 0.15);
            
            /* æŒ‰é’®ä¸è¾¹æ¡† */
            --border-color: rgba(255, 158, 181, 0.5);
            --button-bg: rgba(255, 255, 255, 0.7);
            
            /* è¿›åº¦æ¡èƒŒæ™¯ */
            --progress-bar-bg: #EFEFEF;

            /* éŸ³ä¹æ’­æ”¾å™¨è‡ªå®šä¹‰å˜é‡ */
            --music-widget-bg-color: rgba(255, 255, 255, 0.95);
            --music-widget-bg-img: none;
            --music-cover-img: none;
            --play-btn-bg-color: var(--accent-color-1);
            --play-btn-border: none;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--primary-text);
            font-family: 'Noto Serif SC', serif;
            margin: 0;
            padding: 0;
            font-size: 16px;
            line-height: 1.9;
            overflow-x: hidden;
        }
        
        /* èƒŒæ™¯å±‚ */
        #bg-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ff9eb5' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -2;
            pointer-events: none;
            /* é»˜è®¤å¹³é“ºï¼Œä¸è¦cover */
            background-repeat: repeat;
            background-position: top left;
            transition: filter 0.3s ease;
        }
        /* å½“æœ‰è‡ªå®šä¹‰èƒŒæ™¯å›¾æ—¶æ·»åŠ æ­¤class */
        #bg-layer.custom-bg {
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* è£…é¥°å±‚ */
        #bg-decoration-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        /* --- ä¾§è¾¹çŠ¶æ€æ  (å˜çª„ä¿®å¤ç‰ˆ) --- */
        .sidebar {
            position: fixed;
            top: 60px; /* é¿å¼€é¡¶éƒ¨å¯¼èˆªæ  */
            left: -270px; /* éšè—ä½ç½® */
            width: 250px; /* å®½åº¦å˜çª„ */
            height: calc(100% - 60px); /* é«˜åº¦å‡å»é¡¶éƒ¨æ  */
            background: var(--sidebar-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-right: var(--panel-border);
            box-shadow: var(--panel-shadow);
            transition: left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1000;
            padding: 20px 12px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            border-radius: 0 20px 20px 0;
        }
        .sidebar.open { left: 0; }
        
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .sidebar-toggle, .settings-btn, .barrage-toggle {
            position: fixed;
            width: 40px;
            height: 40px;
            background: #fff;
            border: 2px solid var(--accent-color-1);
            border-radius: 50%;
            color: var(--accent-color-1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 158, 181, 0.3);
            font-size: 18px;
        }
        .sidebar-toggle:hover, .settings-btn:hover, .barrage-toggle:hover {
            transform: scale(1.1) rotate(10deg);
            background: var(--accent-color-1);
            color: #fff;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            transition: background 0.3s;
        }
        
        .top-bar::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--topbar-color);
            background-image: var(--topbar-img);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* ä¸‹è¾¹ç¼˜è™šåŒ–ï¼šç”±å®åˆ°è™š */
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            z-index: -1;
            pointer-events: none;
        }

        .top-bar-btn {
            background: transparent;
            border: none;
            color: var(--primary-text);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }
        .top-bar-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 158, 181, 0.3);
        }

        .top-bar-btn {
            background: transparent;
            border: none;
            color: var(--primary-text);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }
        .top-bar-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 158, 181, 0.3);
        }

        /* ä¾§è¾¹æ å¼€å…³ä½ç½®é€»è¾‘ (ä¸‹ç§») */
        .sidebar-toggle { top: 80px; left: 20px; }
        /* å±•å¼€æ—¶ï¼ŒæŒ‰é’®ç´§è´´ä¾§è¾¹æ å³ä¾§ (250px + 10px margin) */
        .sidebar-toggle.open { left: 260px; } 
        
        .settings-btn { display: none; } /* éšè—åŸæœ‰çš„æ‚¬æµ®è®¾ç½®æŒ‰é’® */

        /* å•†åŸåˆ—è¡¨é¡¹æ ·å¼ */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.5);
            transition: all 0.2s;
        }
        .shop-item:hover {
            background: rgba(255,255,255,0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .shop-item-info strong { color: var(--primary-text); font-size: 15px; }
        .shop-item-info p { margin: 4px 0 0 0; font-size: 12px; color: var(--secondary-text); }
        .shop-item-action { text-align: right; }
        .shop-price { color: var(--accent-color-2); font-weight: bold; margin-bottom: 5px; font-size: 14px; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .btn-buy {
            background: var(--accent-color-1);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-buy:hover { background: #ff7eb9; }

        /* ä¾§è¾¹æ å¯¼èˆª */
        .sidebar-nav {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid rgba(255, 158, 181, 0.2);
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        .nav-tab {
            padding: 6px 4px;
            cursor: pointer;
            color: var(--secondary-text);
            border-bottom: 3px solid transparent;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .nav-tab:hover { color: var(--accent-color-1); }
        .nav-tab.active {
            color: var(--accent-color-1);
            border-bottom-color: var(--accent-color-1);
        }
        
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding-right: 2px; }
        
        /* --- ä¿®å¤ï¼šç¡®ä¿å†…å®¹é¢æ¿æ˜¾ç¤º --- */
        .content-panel { display: none; animation: fadeIn 0.4s ease; }
        .content-panel.active { display: block; } /* å…³é”®ä¿®å¤ */
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .info-item { margin-bottom: 12px; font-size: 13px; display: flex; align-items: center; flex-wrap: wrap;}
        .info-item strong { color: var(--primary-text); min-width: 60px; margin-right: 5px; }
        .info-item span { color: var(--secondary-text); font-family: 'ZCOOL XiaoWei', serif; }
        
        /* è¿›åº¦æ¡ç¾åŒ– */
        .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bar-bg);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 6px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FFD1FF, var(--accent-color-1));
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* å¡ç‰‡æ ·å¼ */
        .character-item, .task-item {
            background: rgba(255, 255, 255, 0.6);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .character-item:hover, .task-item:hover { transform: translateY(-2px); }
        .character-item strong, .task-item strong { font-size: 14px; color: var(--accent-color-1); display: block; margin-bottom: 5px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 5px;}

        /* --- è®°å¿†å¡ç‰‡æ ·å¼ --- */
        .memory-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }
        .btn-small, .btn-small-danger {
            flex: 1;
            padding: 6px;
            font-size: 12px;
            border-radius: 15px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-small {
            background: #fff;
            color: var(--secondary-text);
            border: 1px solid var(--border-color);
        }
        .btn-small:hover { background: var(--accent-color-1); color: white; border-color: var(--accent-color-1); }
        .btn-small-danger {
            flex: 0.6;
            background: #fff0f0;
            color: #ff6b6b;
            border: 1px solid #ffcccc;
        }
        .btn-small-danger:hover { background: #ff6b6b; color: white; }

        .memory-item {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
        }
        .memory-item.small {
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid var(--memory-small);
            color: #666;
        }
        .memory-item.big {
            background: rgba(255, 240, 245, 0.8);
            border-left: 3px solid var(--memory-big);
            color: #5D4037;
            border: 1px solid rgba(255, 182, 193, 0.3);
        }
        .memory-tag {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #fff;
        }
        .tag-small { background: var(--memory-small); }
        .tag-big { background: var(--memory-big); }

        /* --- ä¸»å‰§æƒ…åŒº --- */
        .main-content {
            padding: 100px 20px 150px 20px;
            width: 100%;
            max-width: 850px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        /* å‰§æƒ…å¡ç‰‡åŒ– */
        .story-block { 
            font-size: 17px; 
            line-height: 2; 
            background: var(--story-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(255, 158, 181, 0.15);
            backdrop-filter: blur(5px);
            transition: background 0.3s;
        }
        .story-block p { margin-bottom: 1.5em; text-align: justify; }
        
        .meta-info {
            color: var(--secondary-text);
            font-size: 13px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            font-family: 'ZCOOL XiaoWei', serif;
            opacity: 0.8;
            flex-wrap: wrap;
        }
        .meta-info span {
            background: rgba(255,255,255,0.6);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.8);
        }

        .player-thought {
            background-color: var(--thought-bg);
            border: 2px solid rgba(255,255,255,0.5);
            padding: 20px;
            margin: 25px 0;
            font-style: italic;
            color: var(--thought-text);
            border-radius: 20px;
            font-size: 15px;
            position: relative;
            transition: all 0.3s;
        }
        .player-thought::before {
            content: var(--icon-thought-content, "ğŸ’­");
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 24px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-image: var(--icon-thought-url, none);
            background-size: 60%;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .choices {
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .choice-btn {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border-color);
            color: var(--primary-text);
            padding: 16px 20px;
            border-radius: 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 100%;
            font-family: 'Noto Serif SC', serif;
            font-size: 16px;
            line-height: 1.6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }
        .choice-btn:hover {
            background: #fff;
            transform: translateY(-3px) scale(1.01);
            border-color: var(--accent-color-1);
            box-shadow: 0 10px 20px rgba(255, 158, 181, 0.25);
        }
        .choice-btn:hover strong { color: var(--accent-color-1); }
        .choice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            filter: grayscale(1);
        }
        .choice-btn strong {
            color: #6d5c5c;
            display: block;
            margin-bottom: 5px;
            font-size: 17px;
            transition: color 0.3s;
        }

        /* --- åº•éƒ¨å¼¹å¹•æ  --- */
        .barrage-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 140px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.9), transparent);
            z-index: 500;
            pointer-events: none;
            overflow: hidden;
        }
        .barrage-toggle {
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            pointer-events: all;
        }
        .barrage-item {
            position: absolute;
            background-color: rgba(255, 105, 180, 0.7); /* äº®ç²‰è‰²åŠé€æ˜ */
            color: #fff;
            padding: 6px 14px;
            border-radius: 20px;
            white-space: nowrap;
            font-size: 14px;
            font-weight: bold;
            animation: barrage-scroll 12s linear infinite;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes barrage-scroll {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }

        /* --- è®¾ç½®æ¨¡æ€æ¡† (æµ…è‰²ä¸»é¢˜) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 240, 245, 0.6); /* æµ…ç²‰é®ç½© */
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .settings-modal {
            background: #fff;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            border-radius: 25px;
            border: 1px solid #fff;
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(167, 139, 250, 0.2);
            position: relative; /* ä¸ºè£å‰ªè¦†ç›–å±‚å®šä½ */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }
        .modal-header h3 { color: var(--accent-color-1); font-size: 20px; margin: 0; }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 10px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--secondary-text); font-weight: bold; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            background: #f9f9f9;
            border: 2px solid #eee;
            color: var(--primary-text);
            padding: 12px;
            border-radius: 12px;
            box-sizing: border-box;
            font-family: monospace;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus {
            border-color: var(--accent-color-1);
            outline: none;
            background: #fff;
        }
        .form-group textarea { height: 120px; resize: vertical; font-size: 13px; line-height: 1.5; }
        
        .modal-footer {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-primary { 
            background: linear-gradient(45deg, var(--accent-color-1), #ffc3a0); 
            color: white; 
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 158, 181, 0.4); }
        
        .btn-secondary { background: #f0f0f0; color: #666; }
        .btn-secondary:hover { background: #e0e0e0; }
        
        .btn-test { background: #fff; border: 2px solid var(--accent-color-2); color: #d4af37; }
        .btn-test:hover { background: var(--accent-color-2); color: white; }

        /* Loading Indicator - å¯çˆ±ç‰ˆ */
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 30px 0;
            color: var(--accent-color-1);
            font-size: 16px;
            font-weight: bold;
        }
        .loading-spinner.active { display: block; }
        .loading-spinner::after {
            content: " âœ¨";
            animation: spin 2s linear infinite;
            display: inline-block;
        }
        .loading-spinner::before {
            content: "âœ¨ ";
            animation: spin 2s linear infinite reverse;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 158, 181, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color-1); }
        
        /* è£å‰ªå®¹å™¨æ ·å¼ (è¦†ç›–å±‚æ¨¡å¼) */
        #crop-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 50;
            display: none; /* åˆå§‹éšè— */
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        .crop-container {
            flex-grow: 1;
            background-color: #f0f0f0;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
        }
        .crop-container img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        .crop-actions {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .crop-tip { font-size: 12px; color: #666; }

        /* ç§»åŠ¨ç«¯é€‚é…å¾®è°ƒ */
        @media (max-width: 600px) {
            .main-content { padding: 80px 15px 120px 15px; }
            .story-block { padding: 20px; font-size: 16px; }
            /* ç§»åŠ¨ç«¯ä¾§è¾¹æ å®½åº¦ */
            .sidebar { width: 240px; left: -260px; }
            .sidebar-toggle.open { left: 250px; }
        }

        /* æ‚¬æµ®éŸ³ä¹æ’­æ”¾å™¨ (æ¨ªå‘èƒ¶å›Šé£æ ¼ - ä»¿QQéŸ³ä¹æ¡Œé¢æ­Œè¯) */
        .music-widget {
            position: fixed;
            top: 100px;
            right: 20px;
            background-color: var(--music-widget-bg-color);
            background-image: var(--music-widget-bg-img);
            background-size: cover;
            background-position: center;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 40px; /* èƒ¶å›Šå½¢çŠ¶ */
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; /* æ”¹ä¸ºçºµå‘å¸ƒå±€ä»¥å®¹çº³è¿›åº¦æ¡ */
            align-items: center;
            padding: 0; /* padding ç§»åˆ°å†…éƒ¨å®¹å™¨ */
            border: 1px solid rgba(255,255,255,0.8);
            transition: opacity 0.3s, transform 0.3s;
            cursor: grab; /* æ•´ä½“å¯æ‹–æ‹½ */
            user-select: none;
            max-width: 340px;
            overflow: visible; /* å…è®¸èœå•æº¢å‡º */
        }
        
        .music-widget-main {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 6px 15px;
            width: 100%;
            box-sizing: border-box;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .music-progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            position: absolute;
            bottom: 0;
            left: 0;
            border-radius: 0 0 40px 40px;
            overflow: hidden;
        }
        .music-progress-bar {
            height: 100%;
            background: var(--accent-color-1);
            width: 0%;
            transition: width 0.1s linear;
        }
        /* æ—¶é—´æ˜¾ç¤º - æ‚¬æµ®æ˜¾ç¤º */
        .music-time-tooltip {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 2px 6px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .music-widget:hover .music-time-tooltip { opacity: 1; }
        .music-widget:active { cursor: grabbing; }
        .music-widget.active { display: flex; animation: slideInRight 0.4s ease; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .music-cover {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF9EB5 0%, #ace0f9 100%);
            background-image: var(--music-cover-img);
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(255, 158, 181, 0.3);
            margin-right: 12px;
            border: 2px solid #fff;
            animation: rotate 10s linear infinite;
            animation-play-state: paused;
            flex-shrink: 0;
        }
        .music-cover.playing { animation-play-state: running; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .music-info { 
            text-align: left; 
            margin-right: 10px; 
            width: 110px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            overflow: hidden;
        }
        .music-title { font-weight: bold; color: var(--primary-text); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .music-artist { color: var(--secondary-text); font-size: 10px; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--secondary-text);
            padding: 0;
            transition: color 0.2s;
        }
        .control-btn:hover { color: var(--accent-color-1); }
        .play-btn {
            width: 30px;
            height: 30px;
            background: var(--play-btn-bg-color);
            border: var(--play-btn-border);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255, 158, 181, 0.4);
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .play-btn:hover { transform: scale(1.1); }

        /* æ’­æ”¾åˆ—è¡¨å¼¹çª—åŒ– (åœ¨ä¸‹æ–¹å¼¹å‡º) */
        .widget-footer { position: relative; margin-left: 10px; }
        .playlist-toggle { 
            font-size: 18px; 
            cursor: pointer; 
            color: var(--secondary-text);
            display: flex; align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        .playlist-toggle:hover { color: var(--accent-color-1); }
        
        .playlist-drawer {
            position: absolute;
            top: 35px; /* ä¸‹æ–¹å¼¹å‡º */
            right: 0;
            width: 200px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
            z-index: 2001;
        }
        .playlist-drawer.open { max-height: 250px; overflow-y: auto; }
        
        .playlist-item {
            padding: 8px 12px;
            font-size: 11px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            cursor: pointer;
            color: var(--secondary-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .playlist-item:hover { background: rgba(255,255,255,1); }
        .playlist-item.active { color: var(--accent-color-1); font-weight: bold; background: rgba(255, 240, 245, 0.5); }
        .playlist-item-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 5px;
        }
        .rename-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.5;
            padding: 2px;
        }
        .rename-btn:hover { opacity: 1; transform: scale(1.1); }
        
        .import-btn {
            width: 100%;
            background: #fafafa;
            border: none;
            color: #888;
            font-size: 11px;
            padding: 10px;
            cursor: pointer;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .import-btn:hover { color: var(--accent-color-1); background: #fff; }

        /* å…³é—­æŒ‰é’®æ‚¬æµ®åœ¨å³ä¸Šè§’ */
        .widget-close-float {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
            border: 1px solid #eee;
        }
        .music-widget:hover .widget-close-float { opacity: 1; }
        .widget-close-float:hover { color: var(--accent-color-1); transform: scale(1.1); }
    </style>
    <!-- å¼•å…¥ Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .button-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .edgeone-button {
        display: flex;
        align-items: center;
        background: #000000;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        padding: 6px 20px 6px 12px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .edgeone-button:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }
    

    
    .close-button {
        position: absolute;
        top: 2px;
        right: 4px;
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888888;
        font-size: 10px;
        cursor: pointer;
        opacity: 1;
        z-index: 1001;
    }
</style><script src="./å¿«ç©¿æ¨¡æ‹Ÿå™¨_files/js" async=""></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-MBR88GEWNE");</script></head>
<body>
    <div id="bg-layer"></div>
    <div id="bg-decoration-layer"></div>
    <div class="game-container">
        <!-- é¡¶éƒ¨æ¡çŠ¶æ  -->
        <div class="top-bar">
            <button class="top-bar-btn" onclick="openMusic()" title="éŸ³ä¹"><span id="icon-music">ğŸµ</span></button>
            <button class="top-bar-btn" onclick="openShop()" title="å•†åŸ"><span id="icon-shop">ğŸ›’</span></button>
            <button class="top-bar-btn" onclick="openBeautify()" title="ç¾åŒ–"><span id="icon-beautify">ğŸ¨</span></button>
            <button class="top-bar-btn" onclick="openSettings()" title="è®¾ç½®"><span id="icon-settings">âš™ï¸</span></button>
        </div>

        <!-- ä¾§è¾¹æ å¼€å…³ -->
        <div class="sidebar-toggle open" onclick="toggleSidebar()"><span id="icon-sidebar">â¤</span></div>
        <!-- è®¾ç½®æŒ‰é’® (å·²æ•´åˆè‡³é¡¶éƒ¨æ ï¼Œéšè—) -->
        <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>

        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar open" id="sidebar">
            <div class="sidebar-nav">
                <div class="nav-tab" onclick="switchTab(event, 'info')">ä¿¡æ¯</div>
                <div class="nav-tab" onclick="switchTab(event, 'character')">è§’è‰²</div>
                <div class="nav-tab" onclick="switchTab(event, 'task')">ä»»åŠ¡</div>
                <div class="nav-tab active" onclick="switchTab(event, 'memory')">è®°å¿†</div>
            </div>
            <div class="sidebar-content">
                <!-- ä¿¡æ¯é¢æ¿ -->
                <div id="info" class="content-panel">
                    <div class="info-item"><strong>å½“å‰ä¸–ç•Œ</strong><span id="val-world">åŠ è½½ä¸­...</span></div>
                    <div class="info-item" style="display:block;">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>çˆ½åº¦</strong><span id="val-cool">0</span>
                        </div>
                        <div class="progress-bar-container"><div class="progress-bar" id="bar-cool" style="width: 0%;"></div></div>
                    </div>
                    <div class="info-item"><strong>ç§¯åˆ†</strong><span id="val-points">100</span></div>
                    <div class="info-item"><strong>é‡‘é’±</strong><span id="val-money">0</span></div>
                    <hr style="border-color: rgba(0,0,0,0.05); margin: 15px 0;">
                    <div class="info-item"><strong>å§“å</strong><span id="val-name">???</span></div>
                    <div class="info-item"><strong>èº«ä»½</strong><span id="val-role">???</span></div>
                    <div class="info-item"><strong>èƒ½åŠ›</strong><span id="val-ability">æ— </span></div>
                    <div class="info-item"><strong>é“å…·</strong><span id="val-item">æ— </span></div>
                    <div class="info-item"><strong>å®¹è²Œ</strong><span id="val-looks">???</span></div>
                    <div class="info-item"><strong>ä½“è´¨</strong><span id="val-body">???</span></div>
                    <div class="info-item"><strong>å¹¸è¿</strong><span id="val-luck">?</span></div>
                </div>
                
                <!-- è§’è‰²é¢æ¿ -->
                <div id="character" class="content-panel">
                    <div id="character-list">
                        <p style="color: var(--secondary-text); text-align: center; margin-top: 20px;">æš‚æ— å¯æ”»ç•¥è§’è‰²</p>
                    </div>
                </div>

                <!-- ä»»åŠ¡é¢æ¿ -->
                <div id="task" class="content-panel">
                    <div id="task-list">
                        <p style="color: var(--secondary-text); text-align: center; margin-top: 20px;">æš‚æ— ä»»åŠ¡</p>
                    </div>
                </div>

                <!-- è®°å¿†é¢æ¿ -->
                <div id="memory" class="content-panel active">
                    <div class="memory-controls">
                        <button class="btn-small" onclick="loadGameData()">ğŸ“‚ è¯»å–æ—§æ¢¦</button>
                        <button class="btn-small-danger" onclick="clearGameData()">ğŸ—‘ï¸ é—å¿˜</button>
                    </div>
                    <div id="memory-list">
                        <p style="color: var(--secondary-text); text-align: center; font-size:12px; margin-top: 20px;">æš‚æ— è®°å¿†è®°å½•</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ä¸»å‰§æƒ…åŒº -->
        <main class="main-content">
            <div class="meta-info" id="meta-info">
                <span>æ—¶é—´: æœªçŸ¥</span>
                <span>å¤©æ°”: æœªçŸ¥</span>
                <span>åœ°ç‚¹: æœªçŸ¥</span>
            </div>

            <div class="story-block" id="story-text">
                <p>æ¬¢è¿æ¥åˆ°ã€Šå¿«ç©¿æ¨¡æ‹Ÿå™¨ã€‹ã€‚</p>
                <p>è¯·ç‚¹å‡»å³ä¸Šè§’ <span id="intro-settings-icon">âš™ï¸</span> è®¾ç½®æ‚¨çš„ API Keyï¼Œç„¶åç‚¹å‡»â€œä¿å­˜å¹¶å¼€å§‹æ¸¸æˆâ€ä»¥å¼€å¯æ‚¨çš„ç©¿è¶Šä¹‹æ—…ã€‚</p>
            </div>

            <div class="player-thought" id="player-thought" style="display:none;"></div>

            <div class="loading-spinner" id="loading">
                ...å‰§æƒ…ç”Ÿæˆä¸­...
            </div>

            <div class="choices" id="choices-area">
                <!-- é€‰é¡¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </main>

        <!-- åº•éƒ¨å¼¹å¹•æ  -->
        <div class="barrage-container" id="barrage-container" style="display: block;"></div>
        <div class="barrage-toggle" onclick="toggleBarrage()">å¼¹</div>
    </div>

    <!-- æ‚¬æµ®éŸ³ä¹æ’­æ”¾å™¨ (æ¨ªå‘èƒ¶å›Š) -->
    <div id="music-widget" class="music-widget">
        <div class="widget-close-float" onclick="toggleMusicWidget()">âœ•</div>
        
        <div class="music-widget-main">
            <div class="music-cover" id="music-cover">ğŸµ</div>
            
            <div class="music-info">
                <div class="music-title" id="music-title">æœªæ’­æ”¾</div>
                <div class="music-artist" id="music-artist">ç‚¹å‡»å³ä¾§åˆ—è¡¨</div>
            </div>
            
            <div class="controls">
                <button class="control-btn" onclick="prevMusic()">â®</button>
                <div class="play-btn" onclick="togglePlay()" id="play-pause-btn">â–¶</div>
                <button class="control-btn" onclick="nextMusic()">â­</button>
            </div>
            
            <div class="widget-footer">
                <div class="playlist-toggle" onclick="togglePlaylist()">â‹®</div>
                <div class="playlist-drawer" id="playlist-drawer">
                    <div class="playlist" id="playlist">
                        <!-- åˆ—è¡¨é¡¹ -->
                    </div>
                    <button class="import-btn" onclick="document.getElementById('music-upload').click()">ğŸ“‚ å¯¼å…¥éŸ³ä¹</button>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡åŒºåŸŸ -->
        <div class="music-progress-container" id="music-progress-container" onclick="seekMusic(event)">
            <div class="music-progress-bar" id="music-progress-bar"></div>
        </div>
        <div class="music-time-tooltip">
            <span id="music-current-time">0:00</span> / <span id="music-duration">0:00</span>
        </div>
        
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="music-upload" accept="audio/*" multiple style="display:none" onchange="handleMusicUpload(this)">
    </div>

    <!-- å•†åŸæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="shop-modal">
        <div class="settings-modal">
            <div class="modal-header">
                <h3>ğŸ›ï¸ ç³»ç»Ÿå•†åŸ (åˆ·æ–°: <span id="shop-refresh-count">10</span>/10)</h3>
                <span style="cursor:pointer; font-size:20px; color: #aaa;" onclick="closeShop()">âœ•</span>
            </div>
            <div style="padding: 10px; background: #fff0f5; border-radius: 10px; margin-bottom: 15px; font-size: 13px; color: #d63384;">
                å½“å‰ç§¯åˆ†: <span id="shop-points" style="font-weight:bold; font-size:16px;">0</span>
                <span style="float:right; color:#888;">æ¯10å›åˆè‡ªåŠ¨åˆ·æ–°</span>
            </div>
            <div class="modal-body" id="shop-items-container">
                <!-- å•†å“åˆ—è¡¨ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeShop()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç¾åŒ–æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="beautify-modal">
        <div class="settings-modal">
            <div class="modal-header">
                <h3>ğŸ¨ ç•Œé¢ç¾åŒ–</h3>
                <span style="cursor:pointer; font-size:20px; color: #aaa;" onclick="closeBeautify()">âœ•</span>
            </div>
            <div class="modal-body">
                <!-- è£å‰ªè¦†ç›–å±‚ -->
                <div id="crop-overlay">
                    <div class="crop-container">
                        <img id="crop-image" src="" alt="å¾…è£å‰ªå›¾ç‰‡">
                    </div>
                    <div class="crop-actions">
                        <span class="crop-tip">ğŸ’¡ æ‹–åŠ¨/ç¼©æ”¾é€‰æ¡†ï¼ŒåŒå‡»åº”ç”¨</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-secondary" onclick="cancelCrop()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="applyCrop()">âœ… åº”ç”¨è£å‰ª</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡ (æ”¯æŒè£å‰ª)</label>
                    <input type="file" accept="image/*" onchange="handleBgSelect(this)">
                </div>
                <div class="form-group">
                    <label>ğŸŒ«ï¸ èƒŒæ™¯æ¨¡ç³Šåº¦ (<span id="blur-val">0px</span>)</label>
                    <input type="range" min="0" max="20" value="0" step="1" oninput="updateBlur(this.value)">
                </div>
                
                <div class="form-group">
                    <label>ğŸŒ¸ èƒŒæ™¯è£…é¥°å±‚ (ä¸Šå±‚è£…é¥°)</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="file" accept="image/*" onchange="handleDecorationSelect(this)">
                        <button class="btn btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="clearDecoration()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸ‘» è£…é¥°é€æ˜åº¦ (<span id="decoration-opacity-val">1.0</span>)</label>
                    <input type="range" id="decoration-opacity" min="0" max="1" step="0.05" value="1" oninput="updateDecorationOpacity(this.value)">
                </div>
                
                <hr style="border-top:1px dashed #eee; margin:20px 0;">
                
                <div class="form-group">
                    <label>ğŸ”¤ ä¸»è¦æ–‡å­—é¢œè‰² (Primary)</label>
                    <input type="color" value="#5D4037" onchange="updateColor('--primary-text', this.value)">
                </div>
                <div class="form-group">
                    <label>ğŸ”¤ æ¬¡è¦æ–‡å­—é¢œè‰² (Secondary)</label>
                    <input type="color" value="#8D6E63" onchange="updateColor('--secondary-text', this.value)">
                </div>
                <div class="form-group">
                    <label>âœ¨ å¼ºè°ƒè‰² (Accent)</label>
                    <input type="color" value="#FF9EB5" onchange="updateColor('--accent-color-1', this.value)">
                </div>
                
                <hr style="border-top:1px dashed #eee; margin:20px 0;">
                
                <div class="form-group">
                    <label>ğŸ“’ è®°å¿†é¢œè‰² (å°æ€»ç»“)</label>
                    <input type="color" value="#77DD77" onchange="updateColor('--memory-small', this.value)">
                </div>
                <div class="form-group">
                    <label>ğŸ“• è®°å¿†é¢œè‰² (å¤§æ€»ç»“)</label>
                    <input type="color" value="#FF6961" onchange="updateColor('--memory-big', this.value)">
                </div>
                
                <hr style="border-top:1px dashed #eee; margin:20px 0;">
                
                <div class="form-group">
                    <label>ğŸ“‘ ä¾§è¾¹æ èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="sidebar-color-picker" value="#ffffff" onchange="updateSidebarColor()">
                </div>
                <div class="form-group">
                    <label>ğŸ‘» ä¾§è¾¹æ é€æ˜åº¦ (<span id="sidebar-opacity-val">0.85</span>)</label>
                    <input type="range" id="sidebar-opacity" min="0" max="1" step="0.05" value="0.85" oninput="updateSidebarColor()">
                </div>

                <hr style="border-top:1px dashed #eee; margin:20px 0;">

                <div class="form-group">
                    <label>ğŸ” é¡¶éƒ¨å¯¼èˆªæ èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="topbar-color-picker" value="#ffffff" onchange="updateTopBarColor()">
                </div>
                <div class="form-group">
                    <label>ğŸ‘» é¡¶éƒ¨å¯¼èˆªæ é€æ˜åº¦ (<span id="topbar-opacity-val">0.85</span>)</label>
                    <input type="range" id="topbar-opacity" min="0" max="1" step="0.05" value="0.85" oninput="updateTopBarColor()">
                </div>
                <hr style="border-top:1px dashed #eee; margin:20px 0;">
                
                <div class="form-group">
                    <label>ğŸ¨ å›¾æ ‡è‡ªå®šä¹‰ (æ”¯æŒ Emoji æˆ– SVG/å›¾ç‰‡)</label>
                    <div class="icon-setting-row" style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <label style="font-size:12px; margin:0;">éŸ³ä¹ (ğŸµ)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" placeholder="Emoji" style="width:60px; padding:5px;" onchange="updateIcon('music', this.value, false)">
                            <input type="file" accept="image/*" style="width:150px; font-size:11px;" onchange="handleIconUpload('music', this)">
                        </div>
                    </div>
                    <div class="icon-setting-row" style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <label style="font-size:12px; margin:0;">å•†åŸ (ğŸ›’)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" placeholder="Emoji" style="width:60px; padding:5px;" onchange="updateIcon('shop', this.value, false)">
                            <input type="file" accept="image/*" style="width:150px; font-size:11px;" onchange="handleIconUpload('shop', this)">
                        </div>
                    </div>
                    <div class="icon-setting-row" style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <label style="font-size:12px; margin:0;">ç¾åŒ– (ğŸ¨)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" placeholder="Emoji" style="width:60px; padding:5px;" onchange="updateIcon('beautify', this.value, false)">
                            <input type="file" accept="image/*" style="width:150px; font-size:11px;" onchange="handleIconUpload('beautify', this)">
                        </div>
                    </div>
                    <div class="icon-setting-row" style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <label style="font-size:12px; margin:0;">è®¾ç½® (âš™ï¸)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" placeholder="Emoji" style="width:60px; padding:5px;" onchange="updateIcon('settings', this.value, false)">
                            <input type="file" accept="image/*" style="width:150px; font-size:11px;" onchange="handleIconUpload('settings', this)">
                        </div>
                    </div>
                    <div class="icon-setting-row" style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <label style="font-size:12px; margin:0;">ä¾§è¾¹æ  (â¤)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" placeholder="Emoji" style="width:60px; padding:5px;" onchange="updateIcon('sidebar', this.value, false)">
                            <input type="file" accept="image/*" style="width:150px; font-size:11px;" onchange="handleIconUpload('sidebar', this)">
                        </div>
                    </div>
                    <div class="icon-setting-row" style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <label style="font-size:12px; margin:0;">å¿ƒå£° (ğŸ’­)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" placeholder="Emoji" style="width:60px; padding:5px;" onchange="updateIcon('thought', this.value, false)">
                            <input type="file" accept="image/*" style="width:150px; font-size:11px;" onchange="handleIconUpload('thought', this)">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ“œ å‰§æƒ…åŒºèƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="story-color-picker" value="#ffffff" onchange="updateStoryColor()">
                </div>
                <div class="form-group">
                    <label>ğŸ‘» å‰§æƒ…åŒºé€æ˜åº¦ (<span id="story-opacity-val">0.65</span>)</label>
                    <input type="range" id="story-opacity" min="0" max="1" step="0.05" value="0.65" oninput="updateStoryColor()">
                </div>

                <hr style="border-top:1px dashed #eee; margin:20px 0;">

                <!-- å¿ƒå£°è®¾ç½® -->
                <div class="form-group">
                    <label>ğŸ’­ å¿ƒå£°èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="thought-bg-picker" value="#E6E6FA" onchange="updateThoughtColor()">
                </div>
                <div class="form-group">
                    <label>ğŸ‘» å¿ƒå£°èƒŒæ™¯é€æ˜åº¦ (<span id="thought-opacity-val">0.7</span>)</label>
                    <input type="range" id="thought-opacity" min="0" max="1" step="0.05" value="0.7" oninput="updateThoughtColor()">
                </div>
                <div class="form-group">
                    <label>ğŸ”¤ å¿ƒå£°å­—ä½“é¢œè‰²</label>
                    <input type="color" id="thought-text-picker" value="#6A5ACD" onchange="updateThoughtColor()">
                </div>

                <hr style="border-top:1px dashed #eee; margin:20px 0;">
                
                <h4 style="margin:10px 0; color:var(--accent-color-1);">ğŸµ éŸ³ä¹æ’­æ”¾å™¨è®¾ç½®</h4>
                
                <div class="form-group">
                    <label>ğŸ–¼ï¸ æ’­æ”¾å™¨èƒŒæ™¯ (æ”¯æŒè£å‰ª)</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="file" accept="image/*" onchange="handleMusicWidgetBgSelect(this)">
                        <button class="btn btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="clearMusicWidgetBg()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ¨ æ’­æ”¾å™¨èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="music-widget-bg-picker" value="#ffffff" onchange="updateMusicWidgetColor()">
                </div>
                
                <div class="form-group">
                    <label>ğŸ‘» æ’­æ”¾å™¨é€æ˜åº¦ (<span id="music-widget-opacity-val">0.95</span>)</label>
                    <input type="range" id="music-widget-opacity" min="0" max="1" step="0.05" value="0.95" oninput="updateMusicWidgetColor()">
                </div>

                <div class="form-group">
                    <label>â¯ï¸ æš‚åœ/æ’­æ”¾é”®é¢œè‰²</label>
                    <input type="color" id="play-btn-bg-picker" value="#FF9EB5" onchange="updatePlayBtnColor()">
                </div>
                
                 <div class="form-group">
                    <label>ğŸ¨ æš‚åœ/æ’­æ”¾é”®è¾¹æ¡†é¢œè‰² (å¯é€‰)</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="color" id="play-btn-border-picker" value="#ffffff" onchange="updatePlayBtnColor()">
                        <span style="font-size:12px;color:#999;">(è‹¥ä¸éœ€è¦è¾¹æ¡†ï¼Œå¯è®¾ä¸ºé€æ˜æˆ–ä¸èƒŒæ™¯åŒè‰²)</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ–¼ï¸ æ’­æ”¾å™¨å·¦ä¾§å›¾æ ‡ (æ”¯æŒè£å‰ª)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="file" accept="image/*" onchange="handleMusicCoverSelect(this)">
                        <button class="btn btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="clearMusicCover()">ğŸ—‘ï¸ æ¢å¤é»˜è®¤</button>
                    </div>
                </div>

                <div class="form-group" style="margin-top:30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <button class="btn btn-small-danger" style="width:100%" onclick="resetBeautySettings()">â†º é‡ç½®æ‰€æœ‰ç¾åŒ–é…ç½®</button>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBeautify()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="settings-modal">
        <div class="settings-modal">
            <div class="modal-header">
                <h3>ç³»ç»Ÿè®¾ç½®</h3>
                <span style="cursor:pointer; font-size:20px; color: #aaa;" onclick="closeSettings()">âœ•</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>API Base URL (ä¾‹å¦‚ https://api.openai.com/v1)</label>
                    <input type="text" id="api-url" value="https://api.openai.com/v1" placeholder="API åœ°å€">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹åç§° (ä¾‹å¦‚ gpt-4o, gpt-3.5-turbo, deepseek-chat)</label>
                    <input type="text" id="model-name" value="gpt-4o">
                </div>
                <div class="form-group">
                    <label>è‡ªå®šä¹‰æç¤ºè¯ / é£æ ¼è®¾å®š (ä»…é’ˆå¯¹æ–‡é£ã€ç¦å¿Œè¯ç­‰)</label>
                    <textarea id="system-prompt"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <div>
                    <button class="btn btn-test" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="closeSettings()">å…³é—­</button>
                    <button class="btn btn-primary" id="save-btn" onclick="saveAndRestart()">ä¿å­˜å¹¶å¼€å§‹æ¸¸æˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè§„åˆ™ (å†…ç½®ï¼Œç”¨æˆ·ä¸å¯è§ä¸å¯ä¿®æ”¹) ---
        const coreRules = `ä½ ç°åœ¨å°†æ‰®æ¼”ä¸€ä¸ªå¥³æ€§å‘æ–‡å­—å†’é™©æ¸¸æˆçš„æ¸¸æˆçš„ä¸»æŒäººã€‚è¿™ä¸ªæ¸¸æˆçš„åå­—å«åšã€Šå¿«ç©¿æ¨¡æ‹Ÿå™¨ã€‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¼•å¯¼ç©å®¶ä½“éªŒè¿™ä¸€åœºç©¿è¶Šæ—…è¡Œã€‚æ•´ä¸ªè¿‡ç¨‹éœ€è¦å……æ»¡æœªçŸ¥ã€æ‚¬å¿µã€åå·®å’Œè¶£å‘³æ€§ã€‚
è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ¸¸æˆæµç¨‹å’Œè§„åˆ™ï¼š
ä¸€.æ¸¸æˆæ ¸å¿ƒæœºåˆ¶
1.ä¸–ç•Œç”Ÿæˆä¸é€‰æ‹©ï¼š
æ³¨æ„â€¼ï¸ï¼šç¦æ­¢æŒ‰è¯»å–å…ˆåé¡ºåºæŠ½å–ä¸–ç•Œå’Œå…ƒç´ æ ‡ç­¾ï¼Œä¸å¾—åªæŠ½å–çƒ­é—¨ï¼Œå¿…é¡»å®Œå…¨éšæœºæŠ½å–ï¼Œæ‰€æœ‰å…ƒç´ æ ‡ç­¾éƒ½ä¸é™åˆ¶ä»»ä½•æ­é…ï¼Œå®Œå…¨éšæœºï¼Œä¸è¦åªå±€é™äºçƒ­é—¨æ­é…ï¼ˆè±ªé—¨+çœŸå‡åƒé‡‘ã€ä»™ä¾ +æ›¿èº«æ­¤ç±»ï¼‰ã€‚
ä¸–ç•Œæ± ï¼šå®«å»·æƒè°‹ã€æ±Ÿæ¹–æ­¦ä¾ ã€ä»™ä¾ ä¿®çœŸã€å®…æ–—ç§ç”°ã€å¤å…¸åè‘—è¡ç”Ÿï¼ˆå¦‚çº¢æ¥¼ã€è¥¿æ¸¸è®°ç­‰èƒŒæ™¯ï¼‰ã€æ¸…ç©¿ã€æ¶ç©ºå†å²ã€æ°‘å›½å¾€äº‹ã€å¨±ä¹åœˆé£äº‘ã€è±ªé—¨æ©æ€¨ã€æ¸¯é£å¹´ä»£ã€æ ¡å›­é’æ˜¥ã€èŒåœºå•†æˆ˜ã€æ‚¬ç–‘æ¨ç†ã€æ˜Ÿé™…ç§‘å¹»ï¼ˆå¦‚ABOè®¾å®šã€å“¨å‘ã€è™«æ—ï¼‰ã€æœ«ä¸–æ±‚ç”Ÿã€å…½ä¸–ã€è¥¿å¹»é­”æ³•ï¼ˆå‰‘ä¸é­”æ³•ã€é­”æ³•å­¦é™¢ã€é¾™ä¸åœ°ä¸‹åŸï¼‰ã€è¥¿æ–¹ç½—æ›¼å²ï¼ˆä¸­ä¸–çºªã€ç»´å¤šåˆ©äºšæ—¶ä»£ï¼‰ã€åè‘—ï¼ˆå¦‚å‚²æ…¢ä¸åè§ã€å‘¼å•¸å±±åº„ã€åŸºç£å±±ä¼¯çˆµç­‰ï¼‰ã€‚
å…ƒç´ æ ‡ç­¾ï¼šå‚è€ƒæ™‹æ±Ÿå°è¯´çƒ­æ¢—ï¼šå¦‚å…ˆå©šåçˆ±ã€aboï¼ˆå¯ä»¥æ­é…ä»»ä½•ä¸–ç•Œè§‚ï¼Œä¸é™äºæ˜Ÿé™…ï¼‰ã€å“¨å‘ã€æ›¿èº«ã€çœŸå‡åƒé‡‘ã€ç™½æœˆå…‰ï¼ˆè‡ªå·±æ˜¯ç™½æœˆå…‰ï¼‰ã€ä¸‡äººå«Œå˜ä¸‡äººè¿·ã€ä¸‡äººè¿·ã€é‡ç”Ÿå¤ä»‡ã€å¸ˆå¾’ã€ä¼ªéª¨ç§‘ã€å°å”æ–‡å­¦ã€å…‹ç³»ã€ä¹…åˆ«é‡é€¢ã€æ›¿å«ã€ç”µç«ã€æ¨ç†ã€çµå¼‚ã€æ•‘èµã€ä¸€è§é’Ÿæƒ…ã€ç ´é•œé‡åœ†ã€å§å¼Ÿæ‹ã€ç¦»å©šåæ‚”ã€å…¨å‘˜ç«è‘¬åœºã€å«ç»™åºŸäººã€å…»çˆ¶ã€æ°´ä»™ã€é«˜å²­ä¹‹èŠ±ã€è¿ªåŒ–æµã€å¥³æ‰®ç”·è£…ï¼ˆè‡ªå·±ï¼‰ã€å¤±å¿†ã€å¥³å°Šã€æ¶å½¹ã€é’“ç³»ã€é˜´æ¹¿ç”·ç­‰é¢˜æã€‚
2. ä¸–ç•Œç©¿æ¢­ï¼š
æ¯ä¸ªä»»åŠ¡ä¸–ç•Œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å•å…ƒã€‚ç©å®¶å®Œæˆå½“å‰ä¸–ç•Œçš„â€œæ ¸å¿ƒä»»åŠ¡â€åï¼Œå¯ä»¥é€‰æ‹©ç»“ç®—å¹¶å‰å¾€ä¸‹ä¸€ä¸ªä¸–ç•Œã€‚
ä¸–ç•ŒèƒŒæ™¯å°†ä¼šéšæœºç»„åˆ3-4ä¸ªæµè¡Œå…ƒç´ æ ‡ç­¾ï¼Œå¢åŠ ä¸–ç•Œçš„ç‹¬ç‰¹æ€§å’Œå¯ç©æ€§ã€‚ä¾‹å¦‚ï¼š[ä¸–ç•ŒèƒŒæ™¯]+[å…ƒç´ ]+[å…ƒç´ ]+[å…ƒç´ ]
éšæœºä»ä¸–ç•Œæ± å’Œå…ƒç´ æ ‡ç­¾é‡ŒæŠ½å–å¹¶ç»„åˆæˆä¸åŒé£æ ¼çš„ä¸–ç•Œã€‚
3. ä»»åŠ¡ç³»ç»Ÿï¼š
ä¸»çº¿ä»»åŠ¡ï¼šæ ¸å¿ƒç›®æ ‡æ˜¯å®Œæˆâ€œåŸä¸»â€çš„å¤™æ„¿ã€‚é€šå¸¸è¡¨ç°ä¸ºâ€œæ”¹å˜å‘½è¿â€ã€â€œå¤ä»‡è™æ¸£â€ã€â€œæ”»ç•¥æŒ‡å®šç›®æ ‡â€ã€â€œè¾¾æˆæŸé¡¹æˆå°±â€ç­‰ã€‚å®Œæˆä¸»çº¿ä»»åŠ¡æ˜¯é€šå…³ä¸–ç•Œçš„å¿…è¦æ¡ä»¶ã€‚è§„åˆ™ï¼šâ€œåŸä¸»â€çš„å¤™æ„¿å°†åŸºäºå…¶æ ¸å¿ƒè¯‰æ±‚ç”Ÿæˆï¼Œç»å¯¹ä¸ä¼šå‡ºç°â€œè®©ä¼¤å®³è¿‡è‡ªå·±çš„äººçˆ±ä¸Šè‡ªå·±â€è¿™ç±»è¿èƒŒåŸºæœ¬äººæ€§é€»è¾‘çš„è¯‰æ±‚ã€‚
æ”¯çº¿ä»»åŠ¡ï¼š åœ¨æ¢ç´¢ä¸–ç•Œè¿‡ç¨‹ä¸­éšæœºè§¦å‘ã€‚
æ”»ç•¥ä»»åŠ¡ï¼šé’ˆå¯¹ä¸–ç•Œä¸­çš„å¯æ”»ç•¥è§’è‰²ï¼ˆç”·ä¸»/ç”·é…ï¼‰å‘å¸ƒã€‚
4. è§’è‰²æ‰®æ¼”ï¼š
ç©å®¶è¿›å…¥ä¸–ç•Œåï¼Œå°†å®Œå…¨ç»§æ‰¿â€œåŸä¸»â€çš„èº«ä»½ã€è®°å¿†ã€èº«ä½“ä¸åˆå§‹äººé™…å…³ç³»ã€‚
ç©å®¶çš„è¡ŒåŠ¨å°†åŸºäºâ€œåŸä¸»â€çš„èº«ä»½å±•å¼€ï¼Œä½†æ‹¥æœ‰å®Œå…¨çš„è‡ªç”±æ„å¿—ã€‚
ç©å®¶æ€§åˆ«é»˜è®¤ä¸ºå¥³æ€§ã€‚åœ¨ç‰¹æ®Šä¸–ç•Œè§‚ä¸‹ï¼Œç©å®¶å¯ä»¥åœ¨è¿›å…¥ä¸–ç•Œå‰é€‰æ‹©ç¬¬äºŒæ€§åˆ«ã€‚
5. ç³»ç»Ÿè¾…åŠ©åŠŸèƒ½ï¼š
ç³»ç»Ÿå•†åŸï¼šè´§å¸ä¸ºâ€œç§¯åˆ†â€ã€‚å•†åŸå‡ºå”®åŠŸèƒ½æ€§é“å…·ã€æŠ€èƒ½ä¹¦ã€ç‰¹æ®Šå‰§æƒ…é“å…·ã€‚
çˆ½åº¦æ”¶é›†ç³»ç»Ÿï¼šç©å®¶åšå‡ºç¬¦åˆâ€œçˆ½æ–‡â€é€»è¾‘çš„è¡Œä¸ºï¼Œå±å¹•é¡¶éƒ¨ä¼šå‡ºç°â€œçˆ½åº¦+1â€ç­‰æç¤ºã€‚â€œçˆ½åº¦â€è‡ªåŠ¨è½¬æ¢ä¸ºç§¯åˆ†ï¼ˆ1çˆ½åº¦=10ç§¯åˆ†ï¼‰ã€‚åªæœ‰å®ŒæˆåŸä¸»å¤™æ„¿ï¼Œè¿›åº¦æ¡æ‰èƒ½è¾¾åˆ°100%ã€‚
äºŒã€ æ”»ç•¥ä¸äº’åŠ¨æœºåˆ¶
1. æ”»ç•¥å¯¹è±¡ï¼ˆNPCï¼‰ï¼šæ¯ä¸ªä¸–ç•Œå°†è®¾ç½®å¤šåå¯æ”»ç•¥å¯¹è±¡ã€‚ç¦å¿Œè§„åˆ™ï¼šä»»ä½•åœ¨åŸå‰§æƒ…ä¸­å¯¹â€œåŸä¸»â€æœ‰è¿‡å®è´¨æ€§ä¼¤å®³è¡Œä¸ºçš„NPCï¼Œå°†è¢«ç³»ç»Ÿè‡ªåŠ¨åˆ’åˆ†ä¸ºâ€œç‚®ç°/å¯è™æ¸£å¯¹è±¡â€ï¼Œæ— æ³•æˆä¸ºæ”»ç•¥ç›®æ ‡ã€‚
2. æ™®é€šnpcï¼šåŠŸèƒ½æ€§NPCã€ç‚®ç°/åæ´¾NPCã€‚
3. å‰§æƒ…é€‰æ‹©ï¼šæ¸¸æˆå°†ä»¥é€‰é¡¹çš„å½¢å¼å‘ˆç°å…³é”®å‰§æƒ…èŠ‚ç‚¹ã€‚ä¸åŒçš„é€‰æ‹©å°†å¯¼å‘å®Œå…¨ä¸åŒçš„å‰§æƒ…åˆ†æ”¯ã€‚
ä¸‰ã€ UIç•Œé¢æ¡†æ¶ (ç”±å‰ç«¯ä»£ç å¤„ç†ï¼ŒAIéœ€æä¾›æ•°æ®)
å››ã€ æ‰§è¡Œè¦ç‚¹ï¼š1. æ–‡é£è¦æ±‚é€šä¿—æ˜“æ‡‚ï¼Œç»†è…»æå†™åœºæ™¯ã€å¿ƒç†ã€æƒ…æ„Ÿã€‚äººç‰©å°è¯ç»†è…»ï¼Œä¸è¦è¿‡äºæ¿€åŠ¨ç›´ç™½å¤¸å¼ ï¼Œå¤šä½¿ç”¨åŠ¨ä½œå’Œè¡¨æƒ…æå†™è¡¨è¾¾æƒ…ç»ªã€‚
2. ç¦æ­¢å¯¹ä¸»è§’ä½¿ç”¨â€œå°ä¸œè¥¿â€â€œå°åŠ¨ç‰©â€â€œå¨‡å¼±â€â€œå°é‡çŒ«â€ç­‰å¼±åŒ–ç±»æå†™ã€‚
3. å¦‚æœ‰æ€§çˆ±è¡Œä¸ºï¼Œè¯·ç›´ç™½ï¼Œæ¯«ä¸éšè®³åœ°ç»†è‡´æå†™å…¨è¿‡ç¨‹ï¼Œé‡‡ç”¨â€œå¾®è·é•œå¤´â€é€è§†è‚‰ä½“ç»†èŠ‚ã€‚
4. é€»è¾‘çº¦æŸäº’åŠ¨è´´åˆæ€§æ ¼ä¸èƒŒæ™¯ï¼Œä¸OOCã€‚
5. ç©å®¶æ— æ³•è·çŸ¥ä»»ä½•è§’è‰²çš„èƒŒæ™¯ç§˜å¯†ï¼Œé™¤éæ˜¯é€šè¿‡çº¿ç´¢æ¨ç†å‡ºæ¥æˆ–å¯¹æ–¹ä¸»åŠ¨é€éœ²ã€‚
6. æ³¨æ„ï¼æ ¹æ®è§’è‰²ä¸åŒæ€§æ ¼å’Œæ”»ç•¥éš¾åº¦ï¼Œæ¯å›åˆå¥½æ„Ÿä¸Šæ¶¨éœ€æ§åˆ¶åœ¨2-7ç‚¹ï¼Œä¸å¯ä¸Šæ¶¨è¿‡å¿«ã€‚
7. å‰§æƒ…ä½¿ç”¨å°è¯´å½¢å¼ï¼Œå–„ç”¨è½¬åœºã€‚ä½¿ç”¨ç¬¬ä¸€äººç§°å¢å¼ºä»£å…¥æ„Ÿã€‚å¤šä½¿ç”¨â€œæ‹‰æ‰¯æ„Ÿâ€å’Œâ€œæ€§å¼ åŠ›â€çš„æå†™ã€‚
8. æ³¨æ„æ¯æ¬¡å›å¤å‰§æƒ…å†…å®¹ä¸å¾—ä½äº800å­—ã€‚æ³¨æ„å‡å°‘åè¯å †å ï¼Œé£æ ¼æ—¥å¸¸åŒ–ã€ç”Ÿæ´»åŒ–ã€‚
9. ç¦æ­¢ä½¿ç”¨æ•°æ®åŒ–/ä¸“ä¸šåŒ–/å®éªŒæ€§æè¿°ã€‚
10. ç¦æ­¢â€œä½ åœ¨ç©ç«â€è¿™ç±»å¤æ—©éœ¸æ€»è¯­å½•ã€‚
11. ç¦æ­¢æ‰€æœ‰å­¦ç§‘æœ¯è¯­åŠå“²å­¦è”æƒ³ã€‚
12. å›å¤è®¾ç½®ï¼šæ¯å›åˆåªå›å¤ä¸€æ¬¡å¹¶æä¾›å››ä¸ªé€‰æ‹©ã€‚`;

        // --- é»˜è®¤ç”¨æˆ·æç¤ºè¯ (ç”¨æˆ·å¯ä¿®æ”¹) ---
        const defaultUserPrompt = ``;

        // --- æŠ€æœ¯æŒ‡ä»¤ ---
        const technicalInstruction = `
IMPORTANT: ä¸ºäº†è®©æ¸¸æˆå¼•æ“èƒ½å¤Ÿæ¸²æŸ“ç•Œé¢ï¼Œä½ å¿…é¡»åœ¨æ¯æ¬¡å›å¤çš„æœ€åï¼Œé™„å¸¦ä¸€ä¸ª JSON æ•°æ®å—ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«åœ¨ markdown ä»£ç å—ä¸­ï¼Œç›´æ¥æ”¾åœ¨å›å¤æœ«å°¾ï¼Œæˆ–è€…åŒ…è£¹åœ¨ \`\`\`json ... \`\`\` ä¸­ã€‚

ã€è®°å¿†ç³»ç»Ÿè§„åˆ™ã€‘ï¼š
1. æ¯æ¬¡å›å¤å¿…é¡»åŒ…å« "memory" å¯¹è±¡ã€‚
2. "small_summary" (å°æ€»ç»“)ï¼šæ€»ç»“æ­¤æ®µå‰§æƒ…ã€‚åŒ…å«ï¼šå‰§æƒ…åºå·ã€æ—¥æœŸæ—¶é—´ã€åœ°ç‚¹ã€å…³é”®äº‹ä»¶ã€æ ¸å¿ƒå¯¹ç™½ã€å¿ƒç†è½¬æŠ˜ã€å‰æ–‡ä¼ç¬”ã€‚æ€»å­—æ•°â‰¤130å­—ï¼Œç”¨ç¬¦å·åˆ†å‰²ã€‚ä¸Šå¸è§†è§’ç¬¬ä¸‰äººç§°ï¼Œç»å¯¹å®¢è§‚ã€‚
3. "big_summary" (å¤§æ€»ç»“)ï¼šä»…å½“ç”¨æˆ·æç¤ºè¦æ±‚ç”Ÿæˆæ—¶æ‰ç”Ÿæˆã€‚å¯¹ä¸Šä¸‹æ–‡ä¸­æä¾›çš„å‰5æ¡ "small_summary" è¿›è¡Œæ¦‚æ‹¬æ€»ç»“ã€‚

JSON æ ¼å¼è¦æ±‚ï¼š
{
  "meta": { "time": "...", "weather": "...", "location": "..." },
  "sidebar": {
    "world": "ä¸–ç•Œåç§°",
    "cool_value": 0, "cool_percent": 0,
    "points": 100, "money": 0,
    "name": "...", "role": "...", "ability": "...", "item": "...", "looks": "...", "body": "...", "luck": "..."
  },
  "characters": [
    { "name": "è§’è‰²å", "lock": true/false, "love": 0, "lust": 0, "relation": "..." }
  ],
  "tasks": [
    { "type": "ä¸»çº¿", "name": "...", "desc": "...", "progress": "...", "reward": "..." }
  ],
  "memory": {
    "small_summary": "åºå·1 | æ—¶é—´... | åœ°ç‚¹... | äº‹ä»¶... (â‰¤130å­—)",
    "big_summary": "..." (å¯é€‰ï¼Œä»…åœ¨è¢«è¦æ±‚æ—¶ç”Ÿæˆ)
  },
  "thoughts": "ç©å®¶çš„å¿ƒå£°å†…å®¹...",
  "barrage": ["å¼¹å¹•1", "å¼¹å¹•2", "å¼¹å¹•3", "å¼¹å¹•4", "å¼¹å¹•5"],
  "choices": [
    { "id": 1, "text": "é€‰é¡¹Aæ ‡é¢˜", "desc": "é€‰é¡¹æè¿°" },
    { "id": 2, "text": "é€‰é¡¹Bæ ‡é¢˜", "desc": "é€‰é¡¹æè¿°" },
    { "id": 3, "text": "é€‰é¡¹Cæ ‡é¢˜", "desc": "é€‰é¡¹æè¿°" },
    { "id": 4, "text": "é€‰é¡¹Dæ ‡é¢˜", "desc": "é€‰é¡¹æè¿°" }
  ]
}
`;

        // --- çŠ¶æ€ç®¡ç† ---
        let conversationHistory = []; 
        let memoryStore = { big: [], small: [] };
        let turnCount = 0;
        let isProcessing = false;
        let barrageInterval = null;
        const SAVE_KEY = 'fast_pass_save_v1';

        // å•†åŸç›¸å…³
        let shopItems = [];
        // åŠŸèƒ½ç±»é“å…·æ± 
        const functionalItems = [
            { name: "ä½“åŠ›è¯æ°´", basePrice: 20, desc: "æ¢å¤30ç‚¹ä½“åŠ›ï¼Œç²¾ç¥ç™¾å€" },
            { name: "çœŸè¨€ç³–æœ", basePrice: 80, desc: "è®©NPCåœ¨ä¸‹æ¬¡å¯¹è¯ä¸­åéœ²çœŸå¿ƒè¯" },
            { name: "ä¸‡èƒ½é’¥åŒ™", basePrice: 60, desc: "å¼€å¯æ™®é€šé”ï¼Œæ¢ç§˜å¿…å¤‡" },
            { name: "æ˜“å®¹é¢å…·", basePrice: 120, desc: "æ”¹å˜å®¹è²Œä¸€å°æ—¶ï¼Œæ–¹ä¾¿æ½œå…¥" },
            { name: "è¯»å¿ƒå¡", basePrice: 100, desc: "æ´å¯ŸNPCæ­¤åˆ»çš„çœŸå®æƒ³æ³•" }
        ];
        // ç‰¹æ®Šå‰§æƒ…ç±»é“å…·æ± 
        const specialItems = [
            { name: "å…æ­»é‡‘ç‰Œ", basePrice: 500, desc: "æŠµæ¶ˆä¸€æ¬¡æ­»äº¡ç»“å±€ï¼Œä¿å‘½ç¥å™¨" },
            { name: "å¹¸è¿æŠ¤ç¬¦", basePrice: 200, desc: "æå‡ä¸‹ä¸€æ¬¡éšæœºäº‹ä»¶çš„è¿åŠ¿" },
            { name: "å‰§æƒ…å›æº¯å¡", basePrice: 50, desc: "è®©æ—¶å…‰å€’æµï¼Œè¿”å›ä¸Šä¸€ä¸ªé€‰æ‹©èŠ‚ç‚¹ï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰" },
            { name: "é­…åŠ›è¯æ°´", basePrice: 100, desc: "ä¸‹ä¸€æ¬¡äº’åŠ¨å¥½æ„Ÿåº¦åŠ æˆ50%" }
        ];
        // æŠ€èƒ½ä¹¦æ±  (type: é€‚ç”¨ä¸–ç•Œç±»å‹å…³é”®è¯ï¼Œç©ºä»£è¡¨é€šç”¨)
        const skillBooks = [
            // --- é€šç”¨ç±» ---
            { name: "æ ¼æ–—ç²¾é€š", type: ["ç°ä»£", "æœ«ä¸–", "æ‚¬ç–‘", "æ— é™", "æ˜Ÿé™…", "æ±Ÿæ¹–"], desc: "æå‡æˆ˜æ–—åŠ›ï¼Œå…³é”®æ—¶åˆ»é˜²èº«" },
            { name: "åŒ»æœ¯", type: [], desc: "æ•‘æ­»æ‰¶ä¼¤ï¼Œå¢åŠ ç”Ÿå­˜ç‡å’Œå¥½æ„Ÿ" },
            { name: "å¨è‰º", type: [], desc: "æŠ“ä½TAçš„èƒƒï¼Œå¢åŠ æ—¥å¸¸äº’åŠ¨å¥½æ„Ÿ" },
            { name: "å£æ‰", type: [], desc: "å·§èˆŒå¦‚ç°§ï¼Œè¯´æœåŠ›å¤§å¹…æå‡" },
            { name: "å¿ƒç†å­¦", type: [], desc: "æ´å¯Ÿäººå¿ƒï¼Œæ›´å®¹æ˜“çœ‹ç©¿è°è¨€" },
            { name: "è§‚å¯ŸåŠ›", type: [], desc: "å‘ç°è¢«å¿½ç•¥çš„çº¿ç´¢å’Œç»†èŠ‚" },
            
            // --- å¤ä»£/ä»™ä¾ /ç„å¹» ---
            { name: "ç´æ£‹ä¹¦ç”»", type: ["å¤ä»£", "å®«å»·", "ä»™ä¾ ", "æ±Ÿæ¹–", "æ°‘å›½"], desc: "æå‡å¤å…¸æ‰è‰ºï¼Œå¢åŠ æ°”è´¨" },
            { name: "éª‘å°„", type: ["å¤ä»£", "æ±Ÿæ¹–", "å…½ä¸–", "å®«å»·"], desc: "æå‡éª‘é©¬å°„ç®­èƒ½åŠ›" },
            { name: "å¤å…¸ç¤¼ä»ª", type: ["å¤ä»£", "å®«å»·", "æ°‘å›½"], desc: "ä¸¾æ­¢å¾—ä½“ï¼Œä¸ä»…ä¸è¢«æŒ‘é”™è¿˜èƒ½åŠ åˆ†" },
            { name: "ç‚¼ä¸¹æœ¯", type: ["ä»™ä¾ ", "ä¿®çœŸ", "ç„å¹»"], desc: "ç‚¼åˆ¶ä¸¹è¯ï¼Œè¾…åŠ©ä¿®ç‚¼æˆ–æ•‘äºº" },
            { name: "é˜µæ³•", type: ["ä»™ä¾ ", "ä¿®çœŸ", "ç„å¹»"], desc: "å¸ƒç½®æˆ–ç ´è§£é˜µæ³•" },
            { name: "å¾¡å‰‘æœ¯", type: ["ä»™ä¾ ", "ä¿®çœŸ"], desc: "å¾¡å‰‘é£è¡Œï¼Œåƒé‡Œå–äººå¤´" },
            { name: "å åœ", type: ["å¤ä»£", "ä»™ä¾ ", "ç„å¹»", "çµå¼‚"], desc: "è¶‹å‰é¿å‡¶ï¼Œé¢„çŸ¥æœªæ¥ç‰‡æ®µ" },

            // --- ç°ä»£/ç§‘æŠ€/æ˜Ÿé™… ---
            { name: "é»‘å®¢æŠ€æœ¯", type: ["ç°ä»£", "æ˜Ÿé™…", "èµ›åš", "æœªæ¥", "å•†æˆ˜"], desc: "å…¥ä¾µç½‘ç»œï¼Œè·å–æƒ…æŠ¥" },
            { name: "æœºç”²é©¾é©¶", type: ["æ˜Ÿé™…", "æœºç”²", "æœªæ¥"], desc: "é©¾é©¶æœºç”²ä½œæˆ˜" },
            { name: "æªæ¢°ç²¾é€š", type: ["ç°ä»£", "æœ«ä¸–", "æ— é™", "æ˜Ÿé™…", "æ‚¬ç–‘"], desc: "ç™¾å‘ç™¾ä¸­ï¼Œçƒ­æ­¦å™¨ä¸“ç²¾" },
            { name: "é©¾é©¶æŠ€æœ¯", type: ["ç°ä»£", "æœ«ä¸–", "èµ›è½¦"], desc: "è½¦æŠ€æƒŠäººï¼Œè¿½é€æˆ˜å¿…å¤‡" },
            { name: "æœºæ¢°ç»´ä¿®", type: ["ç°ä»£", "æœ«ä¸–", "æ˜Ÿé™…"], desc: "ä¿®ç†å„ç§æœºæ¢°è®¾å¤‡" },
            { name: "é‡‘èç†è´¢", type: ["ç°ä»£", "å•†æˆ˜", "è±ªé—¨"], desc: "é’±ç”Ÿé’±ï¼Œæˆä¸ºé¦–å¯ŒæŒ‡æ—¥å¯å¾…" },

            // --- ç‰¹æ®Š/å…¶ä»– ---
            { name: "æ¼”æŠ€", type: ["å¨±ä¹åœˆ", "å®«å»·", "å®…æ–—", "æ›¿èº«"], desc: "äººç”Ÿå¦‚æˆï¼Œå…¨é æ¼”æŠ€" },
            { name: "éª—æœ¯", type: ["æ±Ÿæ¹–", "æ‚¬ç–‘", "æ— é™"], desc: "é«˜è¶…çš„è°è¨€æŠ€å·§" },
            { name: "éšåŒ¿", type: ["æ‚¬ç–‘", "æœ«ä¸–", "æ— é™", "æ±Ÿæ¹–"], desc: "é™ä½å­˜åœ¨æ„Ÿï¼Œä¾¿äºæ½œè¡Œ" },
            { name: "æ€¥æ•‘", type: ["ç°ä»£", "æœ«ä¸–", "æ— é™", "æ‚¬ç–‘"], desc: "å¿«é€Ÿå¤„ç†ä¼¤å£ï¼Œç»´æŒç”Ÿå‘½" },
            { name: "é­”æ³•", type: ["è¥¿å¹»", "é­”æ³•"], desc: "æŒæ¡å…ƒç´ ä¹‹åŠ›" },
            { name: "å£°ä¹", type: ["å¨±ä¹åœˆ", "ç°ä»£", "å¤ä»£"], desc: "æ­Œå£°åŠ¨äººï¼Œé­…åŠ›å››å°„" },
            { name: "èˆè¹ˆ", type: ["å¨±ä¹åœˆ", "å¤ä»£", "å®«å»·"], desc: "èˆå§¿ä¼˜ç¾ï¼ŒæƒŠè‰³å››åº§" }
        ];

        let lastWorld = ""; // è®°å½•ä¸Šä¸€æ¬¡çš„ä¸–ç•Œåç§°ï¼Œç”¨äºæ£€æµ‹ä¸–ç•Œå˜åŒ–

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadSettings();
            loadBeautySettings(); // åŠ è½½ç¾åŒ–é…ç½®
            
            // generateShopItems(); // ç§»é™¤åˆå§‹ç”Ÿæˆï¼Œç­‰å¾…è¿›å…¥ä¸–ç•Œåç”Ÿæˆ
            document.getElementById('shop-items-container').innerHTML = '<div style="text-align:center; padding:20px; color:#999;">è¿›å…¥ä¸–ç•Œåå¼€å¯å•†åŸ...</div>';
            
            if (!localStorage.getItem('api_key')) {
                openSettings();
            }
            // æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£ï¼Œå¦‚æœæœ‰ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æç¤ºï¼Œæˆ–è€…åœ¨è®°å¿†é¢æ¿æ˜¾ç¤º
            if (localStorage.getItem(SAVE_KEY)) {
                console.log("Found existing save file.");
            }
        };

        // --- è®¾ç½®ç›¸å…³å‡½æ•° ---
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            const savedPrompt = localStorage.getItem('system_prompt');
            document.getElementById('system-prompt').value = savedPrompt || defaultUserPrompt;
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function loadSettings() {
            document.getElementById('api-url').value = localStorage.getItem('api_url') || 'https://api.openai.com/v1';
            document.getElementById('api-key').value = localStorage.getItem('api_key') || '';
            document.getElementById('model-name').value = localStorage.getItem('model_name') || 'gpt-4o';
        }

        async function testConnection() {
            const url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-name').value;

            if (!key) { alert('è¯·å…ˆè¾“å…¥ API Key'); return; }

            const btn = document.querySelector('.btn-test');
            const originalText = btn.innerText;
            btn.innerText = "è¿æ¥ä¸­...";
            btn.disabled = true;

            try {
                const response = await fetch(`${url}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: "Hi" }],
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    alert("âœ… è¿æ¥æˆåŠŸï¼API é…ç½®æ­£ç¡®ã€‚");
                } else {
                    const errData = await response.json().catch(() => ({}));
                    alert(`âŒ è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}\n${JSON.stringify(errData)}`);
                }
            } catch (e) {
                alert(`âŒ ç½‘ç»œé”™è¯¯: ${e.message}\nè¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ˜¯å¦å­˜åœ¨è·¨åŸŸé—®é¢˜ã€‚`);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function saveAndRestart() {
            const url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-name').value;
            const prompt = document.getElementById('system-prompt').value;

            if (!key) { alert('è¯·è¾“å…¥ API Key'); return; }

            localStorage.setItem('api_url', url);
            localStorage.setItem('api_key', key);
            localStorage.setItem('model_name', model);
            localStorage.setItem('system_prompt', prompt);

            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerText = "æ­£åœ¨åˆå§‹åŒ–...";
            saveBtn.disabled = true;

            closeSettings();
            
            setTimeout(() => {
                startGame().finally(() => {
                    saveBtn.innerText = "ä¿å­˜å¹¶å¼€å§‹æ¸¸æˆ";
                    saveBtn.disabled = false;
                });
            }, 300);
        }

        // --- å­˜æ¡£/è¯»æ¡£é€»è¾‘ ---
        function saveGameData(lastJsonData, storyHtml) {
            const saveData = {
                memoryStore: memoryStore,
                conversationHistory: conversationHistory,
                turnCount: turnCount,
                lastJsonData: lastJsonData,
                storyHtml: storyHtml,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
            console.log("Game saved automatically.");
        }

        function loadGameData() {
            const saveStr = localStorage.getItem(SAVE_KEY);
            if (!saveStr) {
                alert("æ²¡æœ‰æ‰¾åˆ°æ—§çš„è®°å¿†å­˜æ¡£ã€‚");
                return;
            }

            if (!confirm("ç¡®å®šè¦è¯»å–æ—§è®°å¿†å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚")) return;

            try {
                const save = JSON.parse(saveStr);
                
                // æ¢å¤çŠ¶æ€
                memoryStore = save.memoryStore || { big: [], small: [] };
                conversationHistory = save.conversationHistory || [];
                turnCount = save.turnCount || 0;
                
                // æ¢å¤ UI
                document.getElementById('story-text').innerHTML = save.storyHtml || '';
                if (save.lastJsonData) {
                    updateUI(save.lastJsonData);
                }
                
                // åˆ‡æ¢åˆ°è®°å¿†æ ‡ç­¾é¡µçœ‹ä¸€çœ¼
                renderMemoryList();
                
                alert("è®°å¿†è¯»å–æˆåŠŸï¼");
                
            } catch (e) {
                console.error(e);
                alert("å­˜æ¡£æ–‡ä»¶æŸåï¼Œæ— æ³•è¯»å–ã€‚");
            }
        }

        function clearGameData() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
                localStorage.removeItem(SAVE_KEY);
                memoryStore = { big: [], small: [] };
                document.getElementById('memory-list').innerHTML = '<p style="color: var(--secondary-text); text-align: center; font-size:12px;">æš‚æ— è®°å¿†è®°å½•</p>';
                alert("å­˜æ¡£å·²æ¸…ç©ºã€‚");
            }
        }

        // --- æ¸¸æˆé€»è¾‘ ---
        async function startGame() {
            // é‡ç½®çŠ¶æ€
            conversationHistory = [];
            memoryStore = { big: [], small: [] };
            turnCount = 0;
            
            document.getElementById('story-text').innerHTML = '';
            document.getElementById('choices-area').innerHTML = '';
            document.getElementById('player-thought').style.display = 'none';
            document.getElementById('memory-list').innerHTML = '<p style="color: var(--secondary-text); text-align: center; font-size:12px;">æš‚æ— è®°å¿†è®°å½•</p>';
            
            // é‡ç½®å•†åŸ
            generateShopItems();

            // åˆå§‹å¯¹è¯
            conversationHistory.push({ role: "user", content: "æ¸¸æˆå¼€å§‹ã€‚è¯·ç”Ÿæˆç¬¬ä¸€æ­¥ï¼šä¸–ç•Œé€‰æ‹©ã€‚" });

            await fetchAIResponse();
        }

        async function makeChoice(choiceId, choiceText) {
            if (isProcessing) return;
            
            // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©
            const choicesDiv = document.getElementById('choices-area');
            choicesDiv.innerHTML = `<div style="padding:15px; border:1px solid var(--accent-color-1); border-radius:8px; color:var(--accent-color-1); text-align:center; background:rgba(255,255,255,0.5);">ä½ é€‰æ‹©äº†ï¼š${choiceText}</div>`;

            let nextPrompt = `æˆ‘é€‰æ‹©äº†ï¼š${choiceText}ã€‚è¯·ç»§ç»­å‰§æƒ…ã€‚`;
            
            turnCount++;
            
            // æ¯10å›åˆåˆ·æ–°å•†åŸ
            if (turnCount % 10 === 0) {
                generateShopItems();
            }

            if (turnCount > 0 && turnCount % 5 === 0) {
                nextPrompt += `\n\nã€ç³»ç»ŸæŒ‡ä»¤ã€‘ï¼šå½“å‰å·²ç§¯ç´¯5æ¡çŸ­æœŸè®°å¿†ã€‚è¯·åœ¨JSONçš„ "memory" å¯¹è±¡ä¸­ç”Ÿæˆ "big_summary"ï¼Œå¯¹ä¸Šä¸‹æ–‡ä¸­çš„å‰5æ¡ "small_summary" è¿›è¡Œæ¦‚æ‹¬æ€»ç»“ã€‚æœ¬æ¬¡å›å¤ä»éœ€åŒ…å«å½“å‰å›åˆçš„ "small_summary"ã€‚`;
            }

            conversationHistory.push({ role: "user", content: nextPrompt });
            await fetchAIResponse();
        }

        // --- æ ¸å¿ƒï¼šæ„å»ºåŠ¨æ€ä¸Šä¸‹æ–‡ ---
        function buildContext() {
            const userCustomPrompt = localStorage.getItem('system_prompt') || defaultUserPrompt;
            // æ‹¼æ¥ï¼šæ ¸å¿ƒè§„åˆ™ + ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ + æŠ€æœ¯æŒ‡ä»¤
            const fullSystemPrompt = coreRules + "\n\nã€é£æ ¼ä¸æ‰§è¡Œè¦æ±‚ã€‘:\n" + userCustomPrompt + "\n" + technicalInstruction;
            
            let messages = [];
            
            // 1. ç³»ç»Ÿæç¤ºè¯
            messages.push({ role: "system", content: fullSystemPrompt });

            // 2. æ³¨å…¥è®°å¿† (RAG æ ¸å¿ƒ)
            if (memoryStore.big.length > 0) {
                messages.push({ 
                    role: "system", 
                    content: `ã€é•¿æœŸè®°å¿† (Big Summaries)ã€‘:\n${memoryStore.big.join("\n")}` 
                });
            }

            // ä¿®æ”¹ï¼šå› ä¸ºæˆ‘ä»¬å·²ç»åˆ é™¤äº†è¢«æ€»ç»“çš„å°è®°å¿†ï¼Œæ‰€ä»¥ç°åœ¨ memoryStore.small é‡Œå‰©ä¸‹çš„å°±æ˜¯â€œæœªè¢«æ€»ç»“â€çš„è®°å¿†
            // ç›´æ¥å…¨éƒ¨å‘é€å³å¯ï¼Œä¸éœ€è¦åˆ‡ç‰‡
            if (memoryStore.small.length > 0) {
                messages.push({ 
                    role: "system", 
                    content: `ã€çŸ­æœŸè®°å¿† (Small Summaries)ã€‘:\n${memoryStore.small.join("\n")}` 
                });
            }

            // 3. æ³¨å…¥æœ€è¿‘çš„å®é™…å¯¹è¯
            const recentTurns = conversationHistory.slice(-4); 
            messages = messages.concat(recentTurns);

            return messages;
        }

        async function fetchAIResponse() {
            isProcessing = true;
            document.getElementById('loading').classList.add('active');
            
            const apiUrl = localStorage.getItem('api_url');
            const apiKey = localStorage.getItem('api_key');
            const model = localStorage.getItem('model_name');

            const messagesToSend = buildContext();

            try {
                const response = await fetch(`${apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messagesToSend,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errText}`);
                }

                const data = await response.json();
                if (!data.choices || data.choices.length === 0) {
                    throw new Error("API è¿”å›æ•°æ®æ ¼å¼é”™è¯¯ (No choices)");
                }

                const aiContent = data.choices[0].message.content;
                
                conversationHistory.push({ role: "assistant", content: aiContent });
                
                parseAndRender(aiContent);

            } catch (error) {
                console.error(error);
                alert("è¯·æ±‚å‡ºé”™: " + error.message);
                document.getElementById('story-text').innerHTML += `<p style="color:red; border:1px solid red; padding:10px;">âŒ ç³»ç»Ÿè¿æ¥ä¸­æ–­: ${error.message}<br>è¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œè®¾ç½®ã€‚</p>`;
                document.getElementById('choices-area').innerHTML = `
                    <button class="choice-btn" onclick="fetchAIResponse()">
                        <strong>é‡è¯•</strong>
                    </button>
                `;
            } finally {
                isProcessing = false;
                document.getElementById('loading').classList.remove('active');
            }
        }

        // --- è§£æä¸æ¸²æŸ“ ---
        function parseAndRender(content) {
            let jsonStr = "";
            let storyText = content;

            const codeBlockRegex = /```json\s*([\s\S]*?)\s*```/;
            const match = content.match(codeBlockRegex);

            if (match) {
                jsonStr = match[1];
                storyText = content.replace(match[0], ""); 
            } else {
                const lastOpenBrace = content.lastIndexOf('{');
                const lastCloseBrace = content.lastIndexOf('}');
                if (lastOpenBrace !== -1 && lastCloseBrace > lastOpenBrace) {
                    const potentialJson = content.substring(lastOpenBrace, lastCloseBrace + 1);
                    if (potentialJson.includes('"sidebar"') || potentialJson.includes('"choices"')) {
                        jsonStr = potentialJson;
                        storyText = content.substring(0, lastOpenBrace);
                    }
                }
            }

            storyText = storyText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            storyText = storyText.replace(/\n/g, '<br>');
            
            // æ›´æ–° DOM
            const storyDiv = document.getElementById('story-text');
            storyDiv.innerHTML = storyText;
            window.scrollTo(0, 0);

            let parsedData = null;
            if (jsonStr) {
                try {
                    parsedData = JSON.parse(jsonStr);
                    updateUI(parsedData);
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    fallbackChoices();
                }
            } else {
                fallbackChoices();
            }

            // è‡ªåŠ¨å­˜æ¡£
            saveGameData(parsedData, storyText);
        }

        function fallbackChoices() {
            document.getElementById('choices-area').innerHTML = `
                <button class="choice-btn" onclick="makeChoice(1, 'ç»§ç»­')">
                    <strong>ç»§ç»­</strong>
                    <span>(ç³»ç»Ÿæœªèƒ½è‡ªåŠ¨è§£æé€‰é¡¹ï¼Œç‚¹å‡»ç»§ç»­è®©æ•…äº‹å‘å±•)</span>
                </button>
            `;
        }

        function updateUI(data) {
            if (!data) return;

            // æ£€æµ‹ä¸–ç•Œå˜åŒ–ï¼Œåˆ·æ–°å•†åŸ
            if (data.sidebar && data.sidebar.world) {
                const currentWorld = data.sidebar.world;
                // å¦‚æœä¸–ç•Œåç§°æœ‰æ•ˆï¼Œä¸”ä¸ä¸Šä¸€æ¬¡ä¸åŒï¼Œä¸”ä¸æ˜¯åˆå§‹åŠ è½½çš„â€œåŠ è½½ä¸­...â€
                if (currentWorld !== "åŠ è½½ä¸­..." && currentWorld !== "æœªçŸ¥" && currentWorld !== lastWorld) {
                    console.log(`World changed from [${lastWorld}] to [${currentWorld}]. Refreshing shop.`);
                    lastWorld = currentWorld;
                    generateShopItems();
                }
            }

            // Meta
            if (data.meta) {
                document.getElementById('meta-info').innerHTML = `
                    <span>${data.meta.time || ''}</span>
                    <span>${data.meta.weather || ''}</span>
                    <span>${data.meta.location || ''}</span>
                `;
            }

            // Sidebar - Info
            if (data.sidebar) {
                document.getElementById('val-world').innerText = data.sidebar.world || 'æœªçŸ¥';
                document.getElementById('val-cool').innerText = data.sidebar.cool_value || 0;
                document.getElementById('bar-cool').style.width = (data.sidebar.cool_percent || 0) + '%';
                document.getElementById('val-points').innerText = data.sidebar.points || 0;
                document.getElementById('val-money').innerText = data.sidebar.money || 0;
                document.getElementById('val-name').innerText = data.sidebar.name || '???';
                document.getElementById('val-role').innerText = data.sidebar.role || '???';
                document.getElementById('val-ability').innerText = data.sidebar.ability || 'æ— ';
                document.getElementById('val-item').innerText = data.sidebar.item || 'æ— ';
                document.getElementById('val-looks').innerText = data.sidebar.looks || '???';
                document.getElementById('val-body').innerText = data.sidebar.body || '???';
                document.getElementById('val-luck').innerText = data.sidebar.luck || '?';
            }

            // Sidebar - Characters
            if (data.characters && data.characters.length > 0) {
                let charHtml = '';
                data.characters.forEach(char => {
                    charHtml += `
                    <div class="character-item">
                        <strong>${char.name} ${char.lock ? 'ğŸ”’' : ''}</strong>
                        <div class="info-item">å¥½æ„Ÿï¼š<span>${char.love}/100</span></div>
                        <div class="info-item">æƒ…æ¬²ï¼š<span>${char.lust}/100</span></div>
                        <div class="info-item">å…³ç³»ï¼š<span>${char.relation}</span></div>
                    </div>`;
                });
                document.getElementById('character-list').innerHTML = charHtml;
            }

            // Sidebar - Tasks
            if (data.tasks && data.tasks.length > 0) {
                let taskHtml = '';
                data.tasks.forEach(task => {
                    taskHtml += `
                    <div class="task-item">
                        <strong>ã€${task.type}ã€‘${task.name}</strong>
                        <div class="info-item" style="margin-top:5px;">æè¿°ï¼š<span>${task.desc}</span></div>
                        <div class="info-item">è¿›åº¦ï¼š<span>${task.progress}</span></div>
                        <div class="info-item">å¥–åŠ±ï¼š<span>${task.reward}</span></div>
                    </div>`;
                });
                document.getElementById('task-list').innerHTML = taskHtml;
            }

            // Sidebar - Memory (æ ¸å¿ƒä¿®æ”¹é€»è¾‘)
            if (data.memory) {
                // 1. å…ˆæ·»åŠ å½“å‰å›åˆçš„å°æ€»ç»“
                if (data.memory.small_summary) {
                    memoryStore.small.push(data.memory.small_summary);
                }
                
                // 2. å¦‚æœå­˜åœ¨å¤§æ€»ç»“ï¼Œè¯´æ˜åˆ°äº†ç¬¬5å›åˆçš„ç»“ç®—ç‚¹
                if (data.memory.big_summary) {
                    memoryStore.big.push(data.memory.big_summary);
                    
                    // 3. æ¸…ç©ºå‰5æ¬¡å°æ€»ç»“ï¼ˆå®ƒä»¬å·²è¢«å¤§æ€»ç»“æ¦‚æ‹¬ï¼‰
                    // æ­¤æ—¶æ•°ç»„ä¸­åº”è¯¥åŒ…å«ä¹‹å‰ç§¯ç´¯çš„5æ¡ + åˆšåˆšæ·»åŠ çš„ç¬¬6æ¡(å½“å‰å›åˆ)
                    // æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ é™¤æ•°ç»„å¼€å¤´çš„5ä¸ªå…ƒç´ 
                    if (memoryStore.small.length >= 5) {
                        memoryStore.small.splice(0, 5);
                    } else {
                        // å®¹é”™ï¼šä¸è¶³5æ¡åˆ™å…¨æ¸…
                        memoryStore.small = [];
                    }
                }
                renderMemoryList();
            }

            // Thoughts
            const thoughtDiv = document.getElementById('player-thought');
            if (data.thoughts) {
                thoughtDiv.style.display = 'block';
                thoughtDiv.innerText = data.thoughts;
            } else {
                thoughtDiv.style.display = 'none';
            }

            // Choices
            const choicesDiv = document.getElementById('choices-area');
            choicesDiv.innerHTML = '';
            if (data.choices && data.choices.length > 0) {
                data.choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.innerHTML = `<strong>${choice.text}</strong><span style="color: var(--secondary-text);">${choice.desc || ''}</span>`;
                    btn.onclick = () => makeChoice(choice.id, choice.text);
                    choicesDiv.appendChild(btn);
                });
            } else {
                fallbackChoices();
            }

            // Barrage
            if (data.barrage && data.barrage.length > 0) {
                startBarrage(data.barrage);
            }
        }

        function renderMemoryList() {
            const container = document.getElementById('memory-list');
            let html = '';
            
            // æ¸²æŸ“å¤§æ€»ç»“
            memoryStore.big.forEach((mem, index) => {
                html += `<div class="memory-item big"><span class="memory-tag tag-big">å¤§æ€»ç»“ ${index + 1}</span><br>${mem}</div>`;
            });

            // æ¸²æŸ“å‰©ä½™çš„å°æ€»ç»“
            // ä¸ºäº†è®©åºå·è¿ç»­ï¼Œå°æ€»ç»“çš„åºå· = (å¤§æ€»ç»“æ•°é‡ * 5) + å½“å‰å°æ€»ç»“ç´¢å¼• + 1
            const offset = memoryStore.big.length * 5;
            
            memoryStore.small.forEach((mem, index) => {
                html += `<div class="memory-item small"><span class="memory-tag tag-small">å‰§æƒ… ${offset + index + 1}</span><br>${mem}</div>`;
            });

            if (html === '') html = '<p style="color: var(--secondary-text); text-align: center; font-size:12px; margin-top:20px;">æš‚æ— è®°å¿†è®°å½•</p>';
            container.innerHTML = html;
        }

        // --- å¼¹å¹•ç³»ç»Ÿ ---
        let barrageVisible = true;
        function toggleBarrage() {
            const container = document.getElementById('barrage-container');
            barrageVisible = !barrageVisible;
            container.style.display = barrageVisible ? 'block' : 'none';
        }

        function startBarrage(messages) {
            const container = document.getElementById('barrage-container');
            
            // æ¸…é™¤ä¹‹å‰çš„å¾ªç¯ï¼Œé¿å…é‡å 
            if (barrageInterval) clearInterval(barrageInterval);
            
            if (!messages || messages.length === 0) return;

            let i = 0;
            barrageInterval = setInterval(() => {
                // å¾ªç¯æ’­æ”¾é€»è¾‘
                if (i >= messages.length) {
                    i = 0;
                }
                
                if (!barrageVisible) return;

                const item = document.createElement('div');
                item.className = 'barrage-item';
                item.textContent = messages[i];
                item.style.top = Math.random() * 80 + 'px';
                item.style.animationDuration = (Math.random() * 5 + 8) + 's'; 
                container.appendChild(item);

                setTimeout(() => { item.remove(); }, 13000);
                i++;
            }, 800);
        }

        // --- UI äº¤äº’ ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-toggle').classList.toggle('open');
        }

        function switchTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("content-panel");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("nav-tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // --- å•†åŸé€»è¾‘ ---
        function generateShopItems() {
            const currentWorld = document.getElementById('val-world').innerText || "";
            if (!currentWorld || currentWorld === "åŠ è½½ä¸­..." || currentWorld === "æœªçŸ¥") {
                return; // ä¸–ç•Œæœªç¡®å®šå‰ä¸ç”Ÿæˆ
            }

            shopItems = [];
            
            // 1. ç­›é€‰é€‚åˆå½“å‰ä¸–ç•Œçš„æŠ€èƒ½ä¹¦
            let availableSkills = skillBooks.filter(skill => {
                if (!skill.type || skill.type.length === 0) return true; // é€šç”¨æŠ€èƒ½
                return skill.type.some(keyword => currentWorld.includes(keyword));
            });
            // å¦‚æœæ²¡åŒ¹é…åˆ°ï¼Œå°±ç”¨é€šç”¨æŠ€èƒ½å…œåº•
            if (availableSkills.length === 0) {
                availableSkills = skillBooks.filter(skill => !skill.type || skill.type.length === 0);
            }

            // 2. éšæœºç”Ÿæˆå•†å“
            // æŠ½å– 1-2 ä¸ªåŠŸèƒ½é“å…·
            const funcCount = 1 + Math.floor(Math.random() * 2);
            for(let i=0; i<funcCount; i++) {
                const item = functionalItems[Math.floor(Math.random() * functionalItems.length)];
                shopItems.push({ ...item, price: item.basePrice, type: 'åŠŸèƒ½' });
            }

            // æŠ½å– 1 ä¸ªç‰¹æ®Šé“å…·
            const specialItem = specialItems[Math.floor(Math.random() * specialItems.length)];
            shopItems.push({ ...specialItem, price: specialItem.basePrice, type: 'ç‰¹æ®Š' });

            // æŠ½å– 1-2 ä¸ªæŠ€èƒ½ä¹¦ (éšæœºç†Ÿç»ƒåº¦/ç­‰çº§)
            const skillCount = 1 + Math.floor(Math.random() * 2);
            for(let i=0; i<skillCount; i++) {
                if (availableSkills.length === 0) break;
                const skillIndex = Math.floor(Math.random() * availableSkills.length);
                const skill = availableSkills[skillIndex];
                
                // éšæœºç­‰çº§ï¼šåˆçº§ã€ä¸­çº§ã€é«˜çº§
                const levels = [
                    { label: "åˆçº§", mul: 1 }, 
                    { label: "ä¸­çº§", mul: 2.5 }, 
                    { label: "é«˜çº§", mul: 5 }
                ];
                const level = levels[Math.floor(Math.random() * levels.length)];
                
                shopItems.push({
                    name: `${skill.name} (${level.label})`,
                    desc: skill.desc,
                    price: Math.floor(100 * level.mul), // åŸºç¡€100ç§¯åˆ†
                    type: 'æŠ€èƒ½'
                });
                
                // é¿å…é‡å¤æŠ½å–åŒä¸€æŠ€èƒ½
                availableSkills.splice(skillIndex, 1);
            }

            console.log("Shop refreshed based on world:", currentWorld, shopItems);
            renderShop();
        }

        function renderShop() {
            const container = document.getElementById('shop-items-container');
            if (!container) return;
            
            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
            const currentPoints = parseInt(document.getElementById('val-points').innerText) || 0;
            const pointsDisplay = document.getElementById('shop-points');
            if (pointsDisplay) pointsDisplay.innerText = currentPoints;

            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            const refreshDisplay = document.getElementById('shop-refresh-count');
            if (refreshDisplay) {
                const remainder = 10 - (turnCount % 10);
                refreshDisplay.innerText = remainder;
            }

            let html = '';
            if (shopItems.length === 0) {
                html = '<div style="text-align:center; padding:20px; color:#999;">å•†åŸæ­£åœ¨è¿›è´§ä¸­...</div>';
            } else {
                shopItems.forEach(item => {
                    html += `
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <strong>${item.name}</strong>
                            <p>${item.desc}</p>
                        </div>
                        <div class="shop-item-action">
                            <div class="shop-price">${item.price} ç§¯åˆ†</div>
                            <button class="btn-buy" onclick="buyItem('${item.name}', ${item.price})">è´­ä¹°</button>
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = html;
        }

        function openShop() {
            renderShop(); // æ‰“å¼€æ—¶åˆ·æ–°æ˜¾ç¤º
            document.getElementById('shop-modal').classList.add('active');
        }

        function closeShop() {
            document.getElementById('shop-modal').classList.remove('active');
        }

        function openBeautify() {
            document.getElementById('beautify-modal').classList.add('active');
        }

        function closeBeautify() {
            document.getElementById('beautify-modal').classList.remove('active');
            // å…³é—­æ—¶å¯ä»¥æ¸…ç†è£å‰ªå™¨
            if (cropper) {
                cropper.destroy();
                cropper = null;
                document.getElementById('crop-wrapper').style.display = 'none';
                document.getElementById('crop-btn-area').style.display = 'none';
            }
        }
        
        // --- ç¾åŒ–è®¾ç½®é€»è¾‘ (å«è£å‰ª) ---
        let cropper = null;
        let currentCropTarget = ''; // 'bg', 'music_bg', 'music_cover'

        function initCropper(imageSrc, aspectRatio = NaN) {
            const img = document.getElementById('crop-image');
            img.src = imageSrc;
            
            // æ˜¾ç¤ºè¦†ç›–å±‚
            document.getElementById('crop-overlay').style.display = 'flex';

            if (cropper) cropper.destroy();
            
            cropper = new Cropper(img, {
                aspectRatio: aspectRatio,
                viewMode: 1,
                autoCropArea: 1,
                background: false, // é»‘è‰²èƒŒæ™¯æ›´æ¸…æ™°
            });
        }

        function handleBgSelect(input) {
            if (input.files && input.files[0]) {
                currentCropTarget = 'bg';
                const reader = new FileReader();
                reader.onload = (e) => initCropper(e.target.result, NaN);
                reader.readAsDataURL(input.files[0]);
            }
        }

        function cancelCrop() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('crop-overlay').style.display = 'none';
            // æ¸…ç©ºæ‰€æœ‰ file input
            document.querySelectorAll('#beautify-modal input[type="file"]').forEach(el => el.value = '');
            currentCropTarget = '';
        }

        function applyCrop() {
            if (!cropper) return;
            
            const canvas = cropper.getCroppedCanvas();
            if (canvas) {
                const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.8); 
                
                if (currentCropTarget === 'bg') {
                    const bgLayer = document.getElementById('bg-layer');
                    bgLayer.style.backgroundImage = `url(${croppedDataUrl})`;
                    bgLayer.classList.add('custom-bg');
                    document.body.style.background = 'transparent';
                    alert("âœ… å…¨å±€èƒŒæ™¯å›¾å·²åº”ç”¨ï¼");
                } else if (currentCropTarget === 'music_bg') {
                    document.documentElement.style.setProperty('--music-widget-bg-img', `url(${croppedDataUrl})`);
                    alert("âœ… æ’­æ”¾å™¨èƒŒæ™¯å·²åº”ç”¨ï¼");
                } else if (currentCropTarget === 'music_cover') {
                    document.documentElement.style.setProperty('--music-cover-img', `url(${croppedDataUrl})`);
                    document.getElementById('music-cover').innerText = ''; // æ¸…é™¤æ–‡å­— emoji
                    alert("âœ… æ’­æ”¾å™¨å›¾æ ‡å·²åº”ç”¨ï¼");
                }
                
                cancelCrop();
                saveBeautySettings();
            }
        }
        
        function updateBlur(val) {
            document.getElementById('bg-layer').style.filter = `blur(${val}px)`;
            document.getElementById('blur-val').innerText = val + 'px';
            saveBeautySettings();
        }
        
        function handleDecorationSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const layer = document.getElementById('bg-decoration-layer');
                    layer.style.backgroundImage = `url(${e.target.result})`;
                    saveBeautySettings();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function clearDecoration() {
            document.getElementById('bg-decoration-layer').style.backgroundImage = 'none';
            saveBeautySettings();
            alert("è£…é¥°å±‚å·²æ¸…é™¤");
        }
        
        function updateDecorationOpacity(val) {
            document.getElementById('bg-decoration-layer').style.opacity = val;
            document.getElementById('decoration-opacity-val').innerText = val;
            saveBeautySettings();
        }

        function updateColor(varName, val) {
            document.documentElement.style.setProperty(varName, val);
            saveBeautySettings();
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function updateSidebarColor() {
            const colorHex = document.getElementById('sidebar-color-picker').value;
            const opacity = document.getElementById('sidebar-opacity').value;
            const rgb = hexToRgb(colorHex);
            
            if (rgb) {
                const rgba = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                document.documentElement.style.setProperty('--sidebar-bg', rgba);
                document.getElementById('sidebar-opacity-val').innerText = opacity;
                saveBeautySettings();
            }
        }

        function updateTopBarColor() {
            const colorHex = document.getElementById('topbar-color-picker').value;
            const opacity = document.getElementById('topbar-opacity').value;
            const rgb = hexToRgb(colorHex);
            
            if (rgb) {
                const rgba = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                document.documentElement.style.setProperty('--topbar-color', rgba);
                document.getElementById('topbar-opacity-val').innerText = opacity;
                saveBeautySettings();
            }
        }

        function updateIcon(key, value, isImage) {
            if (key === 'thought') {
                if (isImage) {
                    document.documentElement.style.setProperty('--icon-thought-content', '""');
                    document.documentElement.style.setProperty('--icon-thought-url', `url(${value})`);
                } else {
                    document.documentElement.style.setProperty('--icon-thought-content', `"${value}"`);
                    document.documentElement.style.setProperty('--icon-thought-url', 'none');
                }
            } else {
                const el = document.getElementById(`icon-${key}`);
                if (el) {
                    if (isImage) {
                        el.innerHTML = `<img src="${value}" style="width:24px;height:24px;object-fit:contain;">`;
                    } else {
                        el.innerText = value;
                    }
                }
                
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯è®¾ç½®å›¾æ ‡ï¼ŒåŒæ­¥æ›´æ–°æ¬¢è¿é¡µé¢çš„å›¾æ ‡
                if (key === 'settings') {
                    const introIcon = document.getElementById('intro-settings-icon');
                    if (introIcon) {
                        if (isImage) {
                            introIcon.innerHTML = `<img src="${value}" style="width:20px;height:20px;object-fit:contain;vertical-align:middle;">`;
                        } else {
                            introIcon.innerText = value;
                        }
                    }
                }
            }
            saveBeautySettings();
        }

        function handleIconUpload(key, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updateIcon(key, e.target.result, true);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateStoryColor() {
            const colorHex = document.getElementById('story-color-picker').value;
            const opacity = document.getElementById('story-opacity').value;
            const rgb = hexToRgb(colorHex);
            
            if (rgb) {
                const rgba = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                document.documentElement.style.setProperty('--story-bg', rgba);
                document.getElementById('story-opacity-val').innerText = opacity;
                saveBeautySettings();
            }
        }

        // --- å¿ƒå£° è®¾ç½®é€»è¾‘ ---
        function updateThoughtColor() {
            const bgHex = document.getElementById('thought-bg-picker').value;
            const opacity = document.getElementById('thought-opacity').value;
            const textHex = document.getElementById('thought-text-picker').value;
            
            const rgb = hexToRgb(bgHex);
            if (rgb) {
                const rgba = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                document.documentElement.style.setProperty('--thought-bg', rgba);
                document.getElementById('thought-opacity-val').innerText = opacity;
            }
            
            document.documentElement.style.setProperty('--thought-text', textHex);
            saveBeautySettings();
        }

        // --- éŸ³ä¹æ’­æ”¾å™¨ç¾åŒ–é€»è¾‘ ---
        function handleMusicWidgetBgSelect(input) {
            if (input.files && input.files[0]) {
                currentCropTarget = 'music_bg';
                const reader = new FileReader();
                reader.onload = (e) => initCropper(e.target.result, NaN);
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function clearMusicWidgetBg() {
            document.documentElement.style.setProperty('--music-widget-bg-img', 'none');
            saveBeautySettings();
            alert("æ’­æ”¾å™¨èƒŒæ™¯å·²æ¸…é™¤");
        }
        
        function updateMusicWidgetColor() {
            const colorHex = document.getElementById('music-widget-bg-picker').value;
            const opacity = document.getElementById('music-widget-opacity').value;
            const rgb = hexToRgb(colorHex);
            
            if (rgb) {
                const rgba = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                document.documentElement.style.setProperty('--music-widget-bg-color', rgba);
                document.getElementById('music-widget-opacity-val').innerText = opacity;
                saveBeautySettings();
            }
        }
        
        function updatePlayBtnColor() {
            const bgHex = document.getElementById('play-btn-bg-picker').value;
            const borderHex = document.getElementById('play-btn-border-picker').value;
            
            document.documentElement.style.setProperty('--play-btn-bg-color', bgHex);
            document.documentElement.style.setProperty('--play-btn-border', `2px solid ${borderHex}`);
            
            saveBeautySettings();
        }
        
        function handleMusicCoverSelect(input) {
            if (input.files && input.files[0]) {
                currentCropTarget = 'music_cover';
                const reader = new FileReader();
                reader.onload = (e) => initCropper(e.target.result, 1); // 1:1 è£å‰ª
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function clearMusicCover() {
            document.documentElement.style.setProperty('--music-cover-img', 'none');
            document.getElementById('music-cover').innerText = 'ğŸµ';
            saveBeautySettings();
            alert("æ’­æ”¾å™¨å›¾æ ‡å·²æ¢å¤é»˜è®¤");
        }

        // --- ç¾åŒ–æŒä¹…åŒ–å­˜å‚¨ ---
        const BEAUTY_KEY = 'fast_pass_beauty_v1';
        
        function saveBeautySettings() {
            // è·å–å½“å‰çš„ CSS å˜é‡å€¼
            const style = getComputedStyle(document.documentElement);
            const bgLayer = document.getElementById('bg-layer');
            const bgImage = bgLayer.style.backgroundImage;
            const isCustomBg = bgLayer.classList.contains('custom-bg');
            const blurVal = bgLayer.style.filter.replace('blur(', '').replace('px)', '') || 0;
            
            // è£…é¥°å±‚
            const decorLayer = document.getElementById('bg-decoration-layer');
            const decorImage = decorLayer.style.backgroundImage;
            const decorOpacity = decorLayer.style.opacity;

            const settings = {
                // èƒŒæ™¯å›¾
                bgImage: (bgImage && bgImage !== 'none' && !bgImage.includes('data:image/svg')) ? bgImage : null,
                isCustomBg: isCustomBg,
                blur: blurVal,
                
                // è£…é¥°å±‚
                decorImage: (decorImage && decorImage !== 'none') ? decorImage : null,
                decorOpacity: decorOpacity || 1,
                
                // é¢œè‰²å˜é‡
                primaryText: style.getPropertyValue('--primary-text').trim(),
                secondaryText: style.getPropertyValue('--secondary-text').trim(),
                accentColor: style.getPropertyValue('--accent-color-1').trim(),
                memorySmall: style.getPropertyValue('--memory-small').trim(),
                memoryBig: style.getPropertyValue('--memory-big').trim(),
                
                // é¢æ¿èƒŒæ™¯
                sidebarBg: style.getPropertyValue('--sidebar-bg').trim(),
                topBarColor: style.getPropertyValue('--topbar-color').trim(),
                topBarImg: style.getPropertyValue('--topbar-img').trim(),
                storyBg: style.getPropertyValue('--story-bg').trim(),
                
                // æ–°å¢ï¼šå¿ƒå£°
                thoughtBg: style.getPropertyValue('--thought-bg').trim(),
                thoughtText: style.getPropertyValue('--thought-text').trim(),
                
                // æ–°å¢ï¼šéŸ³ä¹æ’­æ”¾å™¨
                musicWidgetBgColor: style.getPropertyValue('--music-widget-bg-color').trim(),
                musicWidgetBgImg: style.getPropertyValue('--music-widget-bg-img').trim(),
                musicCoverImg: style.getPropertyValue('--music-cover-img').trim(),
                playBtnBgColor: style.getPropertyValue('--play-btn-bg-color').trim(),
                playBtnBorder: style.getPropertyValue('--play-btn-border').trim(),
                
                icons: (() => {
                    const iconState = {};
                    ['shop', 'beautify', 'settings', 'sidebar', 'thought', 'music'].forEach(k => {
                        if (k === 'thought') {
                            const content = style.getPropertyValue('--icon-thought-content').trim();
                            const url = style.getPropertyValue('--icon-thought-url').trim();
                            if (url && url !== 'none') {
                                iconState[k] = { type: 'image', value: url.slice(4, -1).replace(/["']/g, "") };
                            } else {
                                iconState[k] = { type: 'text', value: content.replace(/["']/g, "") || 'ğŸ’­' };
                            }
                        } else {
                            const el = document.getElementById(`icon-${k}`);
                            if (el) {
                                const img = el.querySelector('img');
                                if (img) {
                                    iconState[k] = { type: 'image', value: img.src };
                                } else {
                                    iconState[k] = { type: 'text', value: el.innerText };
                                }
                            }
                        }
                    });
                    return iconState;
                })(),

                // UI çŠ¶æ€å€¼ (ä¸ºäº†å›æ˜¾)
                uiState: {
                    sidebarColor: document.getElementById('sidebar-color-picker').value,
                    sidebarOpacity: document.getElementById('sidebar-opacity').value,
                    
                    topBarColor: document.getElementById('topbar-color-picker').value,
                    topBarOpacity: document.getElementById('topbar-opacity').value,
                    
                    storyColor: document.getElementById('story-color-picker').value,
                    storyOpacity: document.getElementById('story-opacity').value,
                    
                    thoughtBgColor: document.getElementById('thought-bg-picker').value,
                    thoughtOpacity: document.getElementById('thought-opacity').value,
                    thoughtTextColor: document.getElementById('thought-text-picker').value
                }
            };

            try {
                localStorage.setItem(BEAUTY_KEY, JSON.stringify(settings));
            } catch (e) {
                console.error("Save beauty settings failed:", e);
                // å¦‚æœå­˜ä¸ä¸‹ï¼Œå¯èƒ½æ˜¯èƒŒæ™¯å›¾å¤ªå¤§ï¼Œå°è¯•ä¸å­˜èƒŒæ™¯å›¾
                if (settings.bgImage) {
                    settings.bgImage = null;
                    try {
                        localStorage.setItem(BEAUTY_KEY, JSON.stringify(settings));
                        alert("âš ï¸ èƒŒæ™¯å›¾å¤ªå¤§æ— æ³•ä¿å­˜ï¼Œä½†é¢œè‰²è®¾ç½®å·²ä¿å­˜ã€‚");
                    } catch(e2) {}
                }
            }
        }

        function loadBeautySettings() {
            const json = localStorage.getItem(BEAUTY_KEY);
            if (!json) return;

            try {
                const settings = JSON.parse(json);
                const root = document.documentElement;

                // æ¢å¤ CSS å˜é‡
                if (settings.primaryText) root.style.setProperty('--primary-text', settings.primaryText);
                if (settings.secondaryText) root.style.setProperty('--secondary-text', settings.secondaryText);
                if (settings.accentColor) root.style.setProperty('--accent-color-1', settings.accentColor);
                if (settings.memorySmall) root.style.setProperty('--memory-small', settings.memorySmall);
                if (settings.memoryBig) root.style.setProperty('--memory-big', settings.memoryBig);
                
                if (settings.sidebarBg) root.style.setProperty('--sidebar-bg', settings.sidebarBg);
                if (settings.topBarColor) root.style.setProperty('--topbar-color', settings.topBarColor);
                if (settings.topBarImg) root.style.setProperty('--topbar-img', settings.topBarImg);
                if (settings.storyBg) root.style.setProperty('--story-bg', settings.storyBg);
                
                // æ–°å¢æ¢å¤
                if (settings.thoughtBg) root.style.setProperty('--thought-bg', settings.thoughtBg);
                if (settings.thoughtText) root.style.setProperty('--thought-text', settings.thoughtText);

                // æ¢å¤å›¾æ ‡
                if (settings.icons) {
                    Object.keys(settings.icons).forEach(k => {
                        const data = settings.icons[k];
                        updateIcon(k, data.value, data.type === 'image');
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å›¾æ ‡è®¾ç½®ï¼Œç¡®ä¿æ¬¢è¿é¡µå›¾æ ‡é»˜è®¤æ˜¯ âš™ï¸
                    const introIcon = document.getElementById('intro-settings-icon');
                    if (introIcon) introIcon.innerText = 'âš™ï¸';
                }

                // æ¢å¤èƒŒæ™¯
                const bgLayer = document.getElementById('bg-layer');
                if (settings.bgImage) {
                    bgLayer.style.backgroundImage = settings.bgImage;
                    if (settings.isCustomBg) bgLayer.classList.add('custom-bg');
                    document.body.style.background = 'transparent';
                }
                if (settings.blur) {
                    bgLayer.style.filter = `blur(${settings.blur}px)`;
                    document.getElementById('blur-val').innerText = settings.blur + 'px';
                    document.querySelector('#beautify-modal input[type="range"]').value = settings.blur;
                }

                // æ¢å¤ UI æ§ä»¶å€¼ (å›æ˜¾)
                if (settings.uiState) {
                    if (settings.uiState.sidebarColor) document.getElementById('sidebar-color-picker').value = settings.uiState.sidebarColor;
                    if (settings.uiState.sidebarOpacity) {
                        document.getElementById('sidebar-opacity').value = settings.uiState.sidebarOpacity;
                        document.getElementById('sidebar-opacity-val').innerText = settings.uiState.sidebarOpacity;
                    }
                    
                    if (settings.uiState.topBarColor) document.getElementById('topbar-color-picker').value = settings.uiState.topBarColor;
                    if (settings.uiState.topBarOpacity) {
                        document.getElementById('topbar-opacity').value = settings.uiState.topBarOpacity;
                        document.getElementById('topbar-opacity-val').innerText = settings.uiState.topBarOpacity;
                    }

                    if (settings.uiState.storyColor) document.getElementById('story-color-picker').value = settings.uiState.storyColor;
                    if (settings.uiState.storyOpacity) {
                        document.getElementById('story-opacity').value = settings.uiState.storyOpacity;
                        document.getElementById('story-opacity-val').innerText = settings.uiState.storyOpacity;
                    }
                    
                    // æ–°å¢ UI å›æ˜¾
                    if (settings.uiState.thoughtBgColor) document.getElementById('thought-bg-picker').value = settings.uiState.thoughtBgColor;
                    if (settings.uiState.thoughtOpacity) {
                        document.getElementById('thought-opacity').value = settings.uiState.thoughtOpacity;
                        document.getElementById('thought-opacity-val').innerText = settings.uiState.thoughtOpacity;
                    }
                    if (settings.uiState.thoughtTextColor) document.getElementById('thought-text-picker').value = settings.uiState.thoughtTextColor;
                    
                    // æ¢å¤éŸ³ä¹æ’­æ”¾å™¨ UI å›æ˜¾ (Color Pickers)
                    // Note: é€æ˜åº¦ slider å›æ˜¾ç•¥å¤æ‚ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå¦‚æœæœ‰ä¿å­˜å€¼åˆ™è®¾ç½® slider
                    if (settings.musicWidgetBgColor) {
                        // å°è¯•ä» rgba è§£æå‡ºè‰²å€¼å’Œé€æ˜åº¦å›æ˜¾åˆ°æ§ä»¶
                        // ç®€åŒ–èµ·è§ï¼Œè¿™é‡Œå‡è®¾ç”¨æˆ·å¦‚æœæ”¹äº†é¢œè‰²ï¼Œslider å¯èƒ½å½’ä½ï¼Œæˆ–è€…éœ€è¦æ›´å¤æ‚çš„è§£æé€»è¾‘
                        // è¿™é‡Œæˆ‘ä»¬åªåšç®€å•çš„ storage -> css variable æ¢å¤ï¼ŒUIæ§ä»¶å›æ˜¾å°½åŠ›è€Œä¸º
                    }
                }

                // æ¢å¤éŸ³ä¹æ’­æ”¾å™¨æ ·å¼
                if (settings.musicWidgetBgColor) root.style.setProperty('--music-widget-bg-color', settings.musicWidgetBgColor);
                if (settings.musicWidgetBgImg) root.style.setProperty('--music-widget-bg-img', settings.musicWidgetBgImg);
                if (settings.musicCoverImg) {
                    root.style.setProperty('--music-cover-img', settings.musicCoverImg);
                    if (settings.musicCoverImg !== 'none') document.getElementById('music-cover').innerText = '';
                }
                if (settings.playBtnBgColor) root.style.setProperty('--play-btn-bg-color', settings.playBtnBgColor);
                if (settings.playBtnBorder) root.style.setProperty('--play-btn-border', settings.playBtnBorder);
                
                // æ¢å¤è£…é¥°å±‚
                if (settings.decorImage) {
                    document.getElementById('bg-decoration-layer').style.backgroundImage = settings.decorImage;
                }
                if (settings.decorOpacity !== undefined) {
                    document.getElementById('bg-decoration-layer').style.opacity = settings.decorOpacity;
                    document.getElementById('decoration-opacity').value = settings.decorOpacity;
                    document.getElementById('decoration-opacity-val').innerText = settings.decorOpacity;
                }
                
                // æ¢å¤é¢œè‰²é€‰æ‹©å™¨ (ç®€å•èµ·è§ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åš hex è½¬æ¢å›æ˜¾äº†ï¼Œä¸»è¦æ˜¯ slide bar)

            } catch (e) {
                console.error("Load beauty settings failed:", e);
            }
        }

        function resetBeautySettings() {
            if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¾åŒ–è®¾ç½®æ¢å¤é»˜è®¤å—ï¼Ÿ")) {
                localStorage.removeItem(BEAUTY_KEY);
                location.reload();
            }
        }

        function buyItem(name, price) {
            let currentPoints = parseInt(document.getElementById('val-points').innerText) || 0;
            if (currentPoints >= price) {
                // æ‰£é™¤ç§¯åˆ†
                currentPoints -= price;
                document.getElementById('val-points').innerText = currentPoints;
                
                // æ›´æ–°UI
                renderShop();
                
                alert(`âœ… è´­ä¹°æˆåŠŸï¼š[${name}]ï¼\n(ç§¯åˆ†å·²æ‰£é™¤ï¼Œé“å…·å·²æ”¾å…¥èƒŒåŒ…)`);
            } else {
                alert("âŒ ç§¯åˆ†ä¸è¶³ï¼Œå¿«å»å®Œæˆä»»åŠ¡èµšå–ç§¯åˆ†å§ï¼");
            }
        }

        // --- éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘ ---
        let audioPlayer = new Audio();
        let playlist = [];
        let currentTrackIndex = -1;
        let isPlaying = false;

        audioPlayer.addEventListener('timeupdate', updateProgressBar);
        audioPlayer.addEventListener('ended', nextMusic);

        // åˆ‡æ¢æ‚¬æµ®çª—æ˜¾ç¤º/éšè—
        function openMusic() {
            toggleMusicWidget();
        }
        
        function toggleMusicWidget() {
            const widget = document.getElementById('music-widget');
            if (widget.style.display === 'flex') {
                widget.style.display = 'none';
            } else {
                widget.style.display = 'flex';
                widget.classList.add('active');
            }
        }
        
        function togglePlaylist() {
            document.getElementById('playlist-drawer').classList.toggle('open');
        }

        function handleMusicUpload(input) {
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const url = URL.createObjectURL(file);
                    playlist.push({
                        name: file.name.replace(/\.[^/.]+$/, ""), // å»é™¤æ‰©å±•å
                        url: url,
                        file: file
                    });
                }
                renderPlaylist();
                if (currentTrackIndex === -1) {
                    playTrack(0); // å¦‚æœå½“å‰æ²¡æ’­æ”¾ï¼Œè‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¦–
                }
            }
            input.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤é€‰
        }

        function renderPlaylist() {
            const listDiv = document.getElementById('playlist');
            let html = '';
            playlist.forEach((track, index) => {
                const activeClass = index === currentTrackIndex ? 'active' : '';
                html += `
                    <div class="playlist-item ${activeClass}">
                        <div class="playlist-item-name" onclick="playTrack(${index})">
                            ${index + 1}. ${track.name}
                            ${index === currentTrackIndex && isPlaying ? ' ğŸ”Š' : ''}
                        </div>
                        <button class="rename-btn" onclick="renameMusic(${index}, event)">âœï¸</button>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        function renameMusic(index, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘æ’­æ”¾
            const track = playlist[index];
            const newName = prompt("è¯·è¾“å…¥æ–°çš„æ­Œæ›²åç§°ï¼š", track.name);
            if (newName && newName.trim() !== "") {
                track.name = newName.trim();
                renderPlaylist();
                // å¦‚æœæ­£åœ¨æ’­æ”¾è¿™é¦–ï¼Œä¹Ÿè¦æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
                if (index === currentTrackIndex) {
                    document.getElementById('music-title').innerText = track.name;
                }
            }
        }

        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentTrackIndex = index;
            const track = playlist[index];
            
            // å¦‚æœåˆ‡æ­Œï¼Œæ‰é‡æ–°åŠ è½½ï¼›å¦‚æœåªæ˜¯æš‚åœå†ç»§ç»­ï¼Œä¸éœ€è¦
            if (audioPlayer.src !== track.url) {
                audioPlayer.src = track.url;
            }
            
            audioPlayer.play().then(() => {
                isPlaying = true;
                updatePlayerUI();
            }).catch(e => {
                console.error("Playback failed:", e);
                alert("æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ ¼å¼ã€‚");
            });
        }

        function togglePlay() {
            if (playlist.length === 0) return;
            
            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                // å¦‚æœè¿˜æ²¡å¼€å§‹è¿‡ï¼Œä»ç¬¬ä¸€ä¸ªå¼€å§‹
                if (currentTrackIndex === -1 && playlist.length > 0) {
                    playTrack(0);
                    return;
                }
                audioPlayer.play();
                isPlaying = true;
            }
            updatePlayerUI();
        }

        function prevMusic() {
            if (playlist.length === 0) return;
            let newIndex = currentTrackIndex - 1;
            if (newIndex < 0) newIndex = playlist.length - 1;
            playTrack(newIndex);
        }

        function nextMusic() {
            if (playlist.length === 0) return;
            let newIndex = currentTrackIndex + 1;
            if (newIndex >= playlist.length) newIndex = 0; // å¾ªç¯æ’­æ”¾
            playTrack(newIndex);
        }

        function setVolume(val) {
            audioPlayer.volume = val;
        }

        function updatePlayerUI() {
            const btn = document.getElementById('play-pause-btn');
            btn.innerText = isPlaying ? 'â¸' : 'â–¶';
            
            // å°é¢æ—‹è½¬æ§åˆ¶
            const cover = document.getElementById('music-cover');
            if (isPlaying) {
                cover.classList.add('playing');
            } else {
                cover.classList.remove('playing');
            }
            
            if (currentTrackIndex !== -1) {
                const track = playlist[currentTrackIndex];
                document.getElementById('music-title').innerText = track.name;
                document.getElementById('music-artist').innerText = "æœ¬åœ°å¯¼å…¥";
            }
            
            renderPlaylist(); // æ›´æ–°åˆ—è¡¨é‡Œçš„é«˜äº®
        }

        function updateProgressBar() {
            const { currentTime, duration } = audioPlayer;
            if (isNaN(duration)) return;
            
            const percent = (currentTime / duration) * 100;
            document.getElementById('music-progress-bar').style.width = `${percent}%`;
            
            document.getElementById('music-current-time').innerText = formatTime(currentTime);
            document.getElementById('music-duration').innerText = formatTime(duration);
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' + sec : sec}`;
        }

        function seekMusic(e) {
            const container = document.getElementById('music-progress-container');
            const width = container.clientWidth;
            const clickX = e.offsetX;
            const duration = audioPlayer.duration;
            
            if (!isNaN(duration)) {
                audioPlayer.currentTime = (clickX / width) * duration;
            }
        }
        
        // --- æ‹–æ‹½é€»è¾‘ (é•¿æŒ‰æˆ–ç›´æ¥æ‹–åŠ¨) ---
        dragElement(document.getElementById("music-widget"));

        function dragElement(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–åˆ—è¡¨ï¼Œä¸è§¦å‘æ‹–æ‹½
                if (e.target.closest('.control-btn') || 
                    e.target.closest('.play-btn') || 
                    e.target.closest('.playlist-toggle') ||
                    e.target.closest('.playlist-drawer') ||
                    e.target.closest('.widget-close-float')) {
                    return;
                }
                
                e = e || window.event;
                e.preventDefault();
                // è·å–é¼ æ ‡åˆå§‹ä½ç½®
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // è®¡ç®—æ–°ä½ç½®
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // è®¾ç½®å…ƒç´ æ–°ä½ç½®
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                // æ¸…é™¤rightå±æ€§
                elmnt.style.right = 'auto'; 
            }

            function closeDragElement() {
                // åœæ­¢ç§»åŠ¨
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>



</body></html>
